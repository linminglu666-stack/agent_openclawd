# OpenClaw-X 完整架构整合文档

## 文档说明

本文档整合了事无巨细的设计思路、流程图、实现细节、模块间数据接口与通信协议。

---


# 第三部分：模块间数据接口与通信协议

## 3.1 统一数据契约

### 核心数据表

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         核心数据表结构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  schedules (调度表):                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • id: 调度ID                                                     │   │
│  │ • workflow_id: 工作流ID                                          │   │
│  │ • version: 版本                                                  │   │
│  │ • enabled: 是否启用                                              │   │
│  │ • policy_json: 调度策略                                          │   │
│  │ • next_fire_at: 下次触发时间                                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  runs (运行表):                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • run_id: 运行ID                                                 │   │
│  │ • trace_id: 追踪ID                                               │   │
│  │ • workflow_id: 工作流ID                                          │   │
│  │ • status: 状态                                                   │   │
│  │ • config_snapshot: 配置快照                                      │   │
│  │ • started_at: 开始时间                                           │   │
│  │ • ended_at: 结束时间                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  node_runs (节点运行表):                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • node_id: 节点ID                                                │   │
│  │ • run_id: 运行ID                                                 │   │
│  │ • status: 状态                                                   │   │
│  │ • snapshot: 快照                                                 │   │
│  │ • started_at: 开始时间                                           │   │
│  │ • ended_at: 结束时间                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  work_items (工作项表):                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • task_id: 任务ID                                                │   │
│  │ • agent_id: AgentID                                              │   │
│  │ • priority: 优先级                                               │   │
│  │ • payload: 负载                                                  │   │
│  │ • status: 状态                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  evidence (证据表):                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • evidence_id: 证据ID                                            │   │
│  │ • trace_id: 追踪ID                                               │   │
│  │ • type: 类型                                                     │   │
│  │ • content: 内容                                                  │   │
│  │ • hash: 哈希值                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  audit_logs (审计日志表):                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • audit_id: 审计ID                                               │   │
│  │ • trace_id: 追踪ID                                               │   │
│  │ • actor: 操作者                                                  │   │
│  │ • action: 操作                                                   │   │
│  │ • resource: 资源                                                 │   │
│  │ • result: 结果                                                   │   │
│  │ • timestamp: 时间戳                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  memory_units (记忆单元表):                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • memory_id: 记忆ID                                              │   │
│  │ • content: 内容                                                  │   │
│  │ • keywords: 关键词                                               │   │
│  │ • category: 类别                                                 │   │
│  │ • scope: 范围                                                    │   │
│  │ • confidence: 置信度                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3.2 模块间接口定义

### Central Brain ↔ Agent Pool

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   Central Brain ↔ Agent Pool 接口                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  CentralBrainToAgentPool:                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ dispatch_task(task, routing_hints) → DispatchResult             │   │
│  │ get_agent_status(agent_id) → AgentStatus                        │   │
│  │ get_pool_stats() → PoolStats                                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  AgentPoolToCentralBrain:                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ on_task_accepted(task_id, agent_id) → void                      │   │
│  │ on_task_rejected(task_id, reason) → void                        │   │
│  │ on_agent_available(agent_id, skills) → void                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  数据结构:                                                               │
│  DispatchResult:                                                        │
│  {                                                                      │
│    "task_id": "t-889",                                                  │
│    "assigned_agent": "a-001",                                          │
│    "reason": "best_match_by_skill_and_load",                           │
│    "alternatives": ["a-002"],                                          │
│    "estimated_start_ms": 500                                           │
│  }                                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Agent ↔ Reasoning Engine

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Agent ↔ Reasoning Engine 接口                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  AgentToReasoningEngine:                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ reason(query, context, strategies, constraints) → Result        │   │
│  │ classify(query) → ProblemType                                   │   │
│  │ get_available_strategies() → [Strategy]                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ReasoningResult:                                                       │
│  {                                                                      │
│    "answer": "...",                                                     │
│    "confidence": 0.85,                                                  │
│    "strategies_used": ["cot", "tot"],                                  │
│    "reasoning_trace": [...],                                            │
│    "evidence_ids": [...],                                               │
│    "trace_id": "tr-001"                                                 │
│  }                                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Message Bus 通道定义

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Message Bus 通道定义                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  预定义通道:                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • agent.heartbeat: Agent心跳上报                                 │   │
│  │ • task.dispatch: 任务分发                                        │   │
│  │ • task.complete: 任务完成                                        │   │
│  │ • task.failed: 任务失败                                          │   │
│  │ • learning.report: 学习报告                                      │   │
│  │ • risk.approval: 风险审批                                        │   │
│  │ • experience.broadcast: 经验广播                                 │   │
│  │ • system.alert: 系统告警                                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  MessageBusInterface:                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ publish(channel, message) → void                                 │   │
│  │ subscribe(channel, handler) → subscription_id                    │   │
│  │ unsubscribe(subscription_id) → void                              │   │
│  │ broadcast(event) → void                                          │   │
│  │ get_channel_stats(channel) → Stats                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---
