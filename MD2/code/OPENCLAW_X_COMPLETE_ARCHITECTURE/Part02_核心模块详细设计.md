# OpenClaw-X 完整架构整合文档

## 文档说明

本文档整合了事无巨细的设计思路、流程图、实现细节、模块间数据接口与通信协议。

---


# 第二部分：核心模块详细设计

## 2.1 Kernel（最小可用内核）

### 设计思路

内核层是整个系统的基石，负责提供最基础的执行能力。设计原则：

1. **最小化**：仅内核 + 适配层，禁止业务逻辑进入内核层
2. **可复现**：随机种子、配置快照写入输出
3. **可插拔**：工具、存储、日志实现可替换

### 接口边界

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Kernel 接口边界                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      ToolAdapter (工具适配器)                    │   │
│  │                                                                 │   │
│  │  exec(command, opts) → {code, stdout, stderr, trace_id}        │   │
│  │  file.read(path) → {content, trace_id}                         │   │
│  │  file.write(path, content, mode) → {ok, bytes, trace_id}       │   │
│  │  web.fetch(url, opts) → {status, body, headers, trace_id}      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     MemoryAdapter (记忆适配器)                   │   │
│  │                                                                 │   │
│  │  add(entry) → {id, trace_id}                                   │   │
│  │  update(id, entry) → {ok, trace_id}                            │   │
│  │  delete(id) → {ok, trace_id}                                   │   │
│  │  query(filter) → {results, trace_id}                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      ContextBus (上下文总线)                     │   │
│  │                                                                 │   │
│  │  current() → {plan_id, round, trace_id, config_snapshot}       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 配置快照结构

```json
{
  "run_id": "run-20260212-001",
  "trace_id": "tr-abc123",
  "timestamp": 1703275200,
  "seed": 42,
  "env": {
    "NODE_ENV": "production",
    "LOG_LEVEL": "info"
  },
  "feature_flags": {
    "enable_tot": true,
    "enable_reflexion": true
  },
  "versions": {
    "kernel": "1.0.0",
    "orchestrator": "1.0.0",
    "reasoning": "1.0.0"
  }
}
```

### 失败场景与回退策略

| 场景 | 检测方式 | 回退策略 |
|------|---------|---------|
| 工具调用失败 | 返回错误码 | 返回错误并写入事件日志，禁止吞错 |
| 读写异常 | 异常捕获 | 回退到只读模式并告警 |
| 网络不可达 | 超时检测 | 触发重试与降级策略 |

---

## 2.2 Scheduler & Orchestrator（调度与编排）

### 设计思路

采用 **schedule-only** 策略，完全移除 cron/timer 触发器，所有触发由调度器的 schedule 引擎按 policy_json 计算 next_fire_at。

### DAG 模型

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           DAG 模型结构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  节点 (Node):                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ {                                                               │   │
│  │   "id": "node-001",                                             │   │
│  │   "type": "task | approval | eval",                            │   │
│  │   "name": "Execute Workflow",                                   │   │
│  │   "retries": 3,                                                 │   │
│  │   "timeout_ms": 300000,                                         │   │
│  │   "idempotency_key": "idem-abc123",                            │   │
│  │   "hook": {                                                     │   │
│  │     "pre": ["risk", "config"],                                 │   │
│  │     "post": ["eval", "trace"]                                  │   │
│  │   }                                                             │   │
│  │ }                                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  边 (Edge):                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ {                                                               │   │
│  │   "from": "node-001",                                           │   │
│  │   "to": "node-002",                                             │   │
│  │   "condition": "success | failure | custom"                    │   │
│  │ }                                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  运行上下文:                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ {                                                               │   │
│  │   "run_id": "run-001",                                          │   │
│  │   "trace_id": "tr-001",                                         │   │
│  │   "config_version": "v1.0.0",                                  │   │
│  │   "feature_flags": {...}                                        │   │
│  │ }                                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Schedule-only 触发策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Schedule-only 触发流程                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  policy_json 类型:                                                      │
│                                                                         │
│  1. at (定点触发):                                                       │
│     {"type": "at", "timestamp": "2026-02-12T10:00:00Z"}                │
│                                                                         │
│  2. interval (间隔触发):                                                 │
│     {"type": "interval", "every_ms": 60000, "jitter_ms": 1000}         │
│                                                                         │
│  3. window (窗口触发):                                                   │
│     {"type": "window", "start_ts": "...", "end_ts": "...",             │
│      "repeat_ms": 600000}                                               │
│                                                                         │
│  触发流程:                                                               │
│                                                                         │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐         │
│  │ schedules│    │ calculate│    │ trigger  │    │orchestr. │         │
│  │   表     │───▶│next_fire_│───▶│  event   │───▶│  run()   │         │
│  │          │    │   at     │    │          │    │          │         │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘         │
│                                                                         │
│  关键约束:                                                               │
│  • 不使用系统 cron 或 systemd timer 作为触发器                           │
│  • 所有触发由调度器的 schedule 引擎计算                                   │
│  • trace_id、config_version、feature_flags 由调度器注入                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 队列策略

| 策略 | 说明 |
|------|------|
| 优先级 | critical/high/medium/low |
| 重试 | 指数回退（max_attempts，backoff_ms） |
| 幂等 | idempotency_key + 状态存储 |

### 层次化任务分解

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      任务分解层次模型                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Level 0: 战略目标                                                       │
│      ↓ 分解                                                             │
│  Level 1: 战术任务                                                       │
│      ↓ 分解                                                             │
│  Level 2: 操作步骤                                                       │
│      ↓ 分解                                                             │
│  Level 3: 原子动作                                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 依赖类型与关键路径

| 依赖类型 | 说明 | 典型场景 |
|---------|------|---------|
| 完成-开始 | 上游完成后下游启动 | 编码→测试 |
| 开始-开始 | 上游开始后下游可并行 | 开发→文档 |
| 完成-完成 | 上游完成后下游结束 | 子模块→总模块 |
| 开始-完成 | 罕见 | 预热→收敛 |

### 调度模式与反模式

| 类型 | 说明 | 风险/收益 |
|------|------|----------|
| 任务链 | 线性依赖 | 简单可靠 |
| 扇出-扇入 | 并行聚合 | 速度快但依赖复杂 |
| 守卫模式 | 条件分支 | 风险可控 |
| 补偿模式 | 失败回滚 | 成本高但安全 |
| 循环依赖 | 反模式 | 死锁风险 |
| 隐式依赖 | 反模式 | 难以调试 |

### 失败策略

| 策略 | 说明 | 适用场景 |
|------|------|---------|
| Fail Fast | 任一失败立即停止 | 高风险任务 |
| Ignore and Continue | 失败记录但继续 | 批处理 |
| Retry with Backoff | 指数回退重试 | 临时故障 |
| Compensation | 补偿回滚 | 分布式事务 |

### 审批与阻断机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         审批与阻断流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  触发条件:                                                               │
│  • risk_score ≥ 阈值                                                    │
│  • 高风险操作（删除、覆盖、权限升级）                                    │
│  • 配置变更                                                              │
│                                                                         │
│  流程:                                                                   │
│                                                                         │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐         │
│  │RiskScorer│───▶│Approval  │───▶│ 人工/规则 │───▶│ 执行/回滚│         │
│  │  评分    │    │  Queue   │    │   审批    │    │          │         │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘         │
│       │                              │                                  │
│       │                              ▼                                  │
│       │                        ┌──────────┐                             │
│       │                        │ 超时回退 │                             │
│       │                        └──────────┘                             │
│       │                              │                                  │
│       └──────────────────────────────┘                                  │
│                                                                         │
│  审批记录:                                                               │
│  • 审批人签名                                                            │
│  • 审批理由                                                              │
│  • trace_id 关联                                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2.3 Central Brain（中央机）

### 设计思路

中央机是整个系统的"大脑"，负责统一分发与治理，协调多Agent并发协作。

### 核心职责

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Central Brain 核心职责                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 任务路由 (Task Router)                                              │
│     • 按技能与负载分配任务                                              │
│     • 权重计算：成功率/延迟/负载                                        │
│     • 优先级：critical/high/medium/low                                 │
│                                                                         │
│  2. 风险裁决 (Risk Adjudicator)                                         │
│     • 高风险任务强制审批                                                │
│     • 风险评分与因子分析                                                │
│     • 降级策略决策                                                      │
│                                                                         │
│  3. 经验广播 (Experience Broadcast)                                     │
│     • 优秀策略与技能回流                                                │
│     • 跨租户共享通用知识                                                │
│     • 学习成果分发                                                      │
│                                                                         │
│  4. 资源调度 (Resource Scheduler)                                       │
│     • CPU/内存/队列深度动态调度                                         │
│     • Agent池扩缩容                                                    │
│     • 负载均衡                                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 智能模型路由与元认知调节

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    智能模型路由架构                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  元认知层: 监测路由效果 → 评估策略有效性 → 触发调整                        │
│  路由层: 复杂度估计 + 成本权衡 + 模型选择                                 │
│                                                                         │
│  路由决策输入:                                                           │
│  • 任务难度与不确定性                                                   │
│  • 成本/延迟/质量权重                                                   │
│  • 历史效果与探索-利用策略                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 错误模式库与元模式机制

| 能力 | 说明 | 作用 |
|------|------|------|
| 错误模式库 | 记录高频失败形态 | 快速阻断与修复 |
| 模式老化 | 长期未触发自动降权 | 避免规则固化 |
| 低置信模式 | 高假阳性自动质疑 | 降低误阻断 |
| 模式冲突 | 规则互斥检测 | 防止策略互相抵消 |

### 认知债务量化

| 指标 | 说明 | 处置 |
|------|------|------|
| unknown_reasons | 无法解释的决策 | 强制补证据 |
| manual_bypasses | 绕过自动化 | 提升风险等级 |
| orphan_rules | 无根因支撑规则 | 进入清理列表 |

### 任务分发策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         任务分发流程                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输入: Task Dispatch Request                                            │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        分发决策流程                               │  │
│  │                                                                  │  │
│  │  1. 收集所有 agent 心跳                                          │  │
│  │     ↓                                                            │  │
│  │  2. 过滤满足 required_skill 的 agent                             │  │
│  │     ↓                                                            │  │
│  │  3. 计算权重 = 成功率/延迟/负载                                  │  │
│  │     ↓                                                            │  │
│  │  4. 选择最佳 agent                                               │  │
│  │     ↓                                                            │  │
│  │  5. 若 queue_depth 过高则降级                                    │  │
│  │     ↓                                                            │  │
│  │  6. 派发 task 并记录 audit                                       │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  输出: Task Routing Result                                              │
│  {                                                                      │
│    "task_id": "t-889",                                                  │
│    "assigned_agent": "a-001",                                          │
│    "reason": "best_match_by_skill_and_load",                           │
│    "alternatives": ["a-002", "a-003"],                                 │
│    "estimated_start_ms": 500                                           │
│  }                                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2.4 Agent Pool（Agent池）

### 设计思路

Agent池管理多个并发Agent实例，支持技能匹配、负载均衡、资源隔离。

### Agent 生命周期状态机

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Agent 状态机                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                    ┌─────────────────────────────────────┐              │
│                    │                                     │              │
│                    ▼                                     │              │
│              ┌──────────┐  task_assigned   ┌──────────┐  │              │
│              │   IDLE   │ ───────────────▶ │ RUNNING  │  │              │
│              └──────────┘                  └──────────┘  │              │
│                    ▲                              │      │              │
│                    │                              │      │              │
│                    │ task_completed               │      │              │
│                    │                              ▼      │              │
│                    │                        ┌──────────┐ │              │
│                    │      rollback_complete │  FAILED  │ │              │
│                    │                        └──────────┘ │              │
│                    │                              │      │              │
│                    │         idle_timeout        │      │              │
│                    │                              ▼      │              │
│                    │                        ┌──────────┐ │              │
│                    ├─────────────────────── │ BLOCKED  │ │              │
│                    │                        └──────────┘ │              │
│                    │                              │      │              │
│                    │                   unblocked  │      │              │
│                    │                              │      │              │
│                    ▼                              ▼      │              │
│              ┌──────────┐  learning_complete ┌──────────┐│              │
│              │ LEARNING │ ◀───────────────── │  (from   ││              │
│              └──────────┘                    │  any)    ││              │
│                    │                         └──────────┘│              │
│                    │ learning_complete                    │              │
│                    └─────────────────────────────────────┘              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 状态转换规则表

| 当前状态 | 事件 | 目标状态 | 条件 | 动作 |
|---------|------|---------|------|------|
| IDLE | task_assigned | RUNNING | 有可用资源 | 创建快照, 开始执行 |
| IDLE | idle_timeout | LEARNING | idle_time >= 60s | 触发自学习 |
| RUNNING | task_completed | IDLE | 成功 | 记录指标, 释放资源 |
| RUNNING | task_failed | FAILED | 失败 | 记录错误, 触发恢复 |
| RUNNING | blocked | BLOCKED | 依赖未满足 | 等待依赖 |
| FAILED | rollback_complete | IDLE | 回滚成功 | 恢复快照 |
| FAILED | retry | RUNNING | retry_count < max | 重试任务 |
| BLOCKED | unblocked | RUNNING | 依赖满足 | 继续执行 |
| BLOCKED | timeout | FAILED | 等待超时 | 记录超时 |
| LEARNING | learning_complete | IDLE | 学习完成 | 注册技能 |
| LEARNING | learning_failed | IDLE | 学习失败 | 记录日志 |

### Agent 心跳协议

```json
{
  "agent_id": "a-001",
  "status": "idle",
  "cpu": 0.12,
  "mem": 0.34,
  "queue_depth": 12,
  "last_task": "t-889",
  "trace_id": "tr-001",
  "timestamp": 1703275200,
  "version": "1.0.0",
  "skills": ["orchestrator_dag_owner", "code_generator"],
  "metrics": {
    "success_rate": 0.95,
    "avg_latency_ms": 1200,
    "total_tasks": 150,
    "failed_tasks": 7
  },
  "health": {
    "is_healthy": true,
    "last_error": null,
    "consecutive_failures": 0
  },
  "resource_limits": {
    "cpu_limit": 2.0,
    "mem_limit_mb": 4096,
    "current_usage_mb": 1024
  }
}
```

---

## 2.5 Reasoning Enhancement（推理增强层）

### 设计思路

通过多种推理策略提升大模型的推理深度和答案准确性。

### 策略路由流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        策略路由决策流程                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输入: 用户问题                                                         │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      问题分类器                                   │  │
│  │                                                                  │  │
│  │  分类维度:                                                        │  │
│  │  • factual_qa: 事实问答 → 直接回答 + CoT                         │  │
│  │  • multi_step_reasoning: 多步推理 → ToT + Scratchpad             │  │
│  │  • code_generation: 代码生成 → CodeInterpreter + 测试            │  │
│  │  • open_analysis: 开放分析 → SelfConsistency + Reflexion         │  │
│  │  • creative_writing: 创意写作 → ToT + 多样性采样                 │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      策略选择器                                   │  │
│  │                                                                  │  │
│  │  根据问题类型选择策略组合:                                        │  │
│  │  • 简单问题: [CoT]                                               │  │
│  │  • 中等问题: [CoT, SelfConsistency]                              │  │
│  │  • 复杂问题: [CoT, ToT, Reflexion, TruthGate]                    │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  输出: 策略执行结果 + 置信度                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 推理策略详解

#### 2.5.1 CoT Injector（思维链注入）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        CoT 注入流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  原始问题: "计算 15% 的 240 是多少？"                                    │
│                                                                         │
│  注入后 Prompt:                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 请一步步思考并回答以下问题：                                     │   │
│  │                                                                 │   │
│  │ 问题：计算 15% 的 240 是多少？                                  │   │
│  │                                                                 │   │
│  │ 让我们一步步来：                                                │   │
│  │ 1. 首先，理解问题...                                            │   │
│  │ 2. 然后，...                                                    │   │
│  │ 3. 最后，...                                                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  注入模板:                                                               │
│  • zero_shot: "请一步步思考..."                                        │
│  • few_shot: 带示例的模板                                              │
│  • auto: 根据问题类型自动选择                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2.5.2 Self-Consistency（自一致性采样）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Self-Consistency 流程                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────┐     ┌──────────┐     ┌──────────┐                        │
│  │ Sample 1 │     │ Sample 2 │     │ Sample N │                        │
│  │ 答案: A  │     │ 答案: B  │     │ 答案: A  │                        │
│  └────┬─────┘     └────┬─────┘     └────┬─────┘                        │
│       │                │                │                               │
│       └────────────────┼────────────────┘                               │
│                        │                                                │
│                        ▼                                                │
│              ┌──────────────────┐                                       │
│              │   多数投票聚合   │                                       │
│              │   A: 2票, B: 1票 │                                       │
│              └────────┬─────────┘                                       │
│                       │                                                 │
│                       ▼                                                 │
│              ┌──────────────────┐                                       │
│              │   最终答案: A    │                                       │
│              │   置信度: 0.67   │                                       │
│              └──────────────────┘                                       │
│                                                                         │
│  参数配置:                                                               │
│  • num_samples: 采样次数 (默认: 5)                                      │
│  • temperature: 采样温度 (默认: 0.7)                                    │
│  • aggregation: 聚合方式 (majority/weighted)                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2.5.3 Tree-of-Thought（思维树）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ToT 思维树展开                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                         ┌───────────┐                                   │
│                         │   问题    │                                   │
│                         └─────┬─────┘                                   │
│                               │                                         │
│               ┌───────────────┼───────────────┐                         │
│               │               │               │                         │
│               ▼               ▼               ▼                         │
│         ┌──────────┐   ┌──────────┐   ┌──────────┐                     │
│         │ 思路 A   │   │ 思路 B   │   │ 思路 C   │                     │
│         │ 评分:0.8 │   │ 评分:0.6 │   │ 评分:0.9 │                     │
│         └────┬─────┘   └────┬─────┘   └────┬─────┘                     │
│              │              │              │                            │
│              │              │              ▼                            │
│              │              │        ┌──────────┐                       │
│              │              │        │ 深入 C   │                       │
│              │              │        │ 评分:0.85│                       │
│              │              │        └────┬─────┘                       │
│              │              │             │                             │
│              └──────────────┴─────────────┘                             │
│                             │                                           │
│                             ▼                                           │
│                      ┌───────────┐                                      │
│                      │ 最优路径  │                                      │
│                      │ C → C'    │                                      │
│                      └───────────┘                                      │
│                                                                         │
│  参数配置:                                                               │
│  • max_depth: 最大深度 (默认: 3)                                        │
│  • beam_width: 每层保留节点数 (默认: 3)                                  │
│  • evaluation: 评估方式 (llm/heuristic)                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2.5.4 Reflexion（反思迭代）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Reflexion 反思迭代流程                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                                                                  │  │
│  │   ┌──────────┐    ┌──────────┐    ┌──────────┐                  │  │
│  │   │ 初始回答 │───▶│ 自我评估 │───▶│ 反思生成 │                  │  │
│  │   └──────────┘    └──────────┘    └──────────┘                  │  │
│  │                          │              │                        │  │
│  │                          │              ▼                        │  │
│  │                          │       ┌──────────┐                    │  │
│  │                          │       │ 改进回答 │                    │  │
│  │                          │       └────┬─────┘                    │  │
│  │                          │            │                          │  │
│  │                          │            ▼                          │  │
│  │                          │       ┌──────────┐                    │  │
│  │                          └──────▶│ 满足条件?│                    │  │
│  │                                  └────┬─────┘                    │  │
│  │                                       │                          │  │
│  │                               否 ─────┼───── 是                   │  │
│  │                               │       │       │                  │  │
│  │                               ▼       │       ▼                  │  │
│  │                        ┌──────────┐   │  ┌──────────┐            │  │
│  │                        │ 继续迭代 │───┘  │ 最终答案 │            │  │
│  │                        └──────────┘      └──────────┘            │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  参数配置:                                                               │
│  • max_iterations: 最大迭代次数 (默认: 3)                               │
│  • satisfaction_threshold: 满意度阈值 (默认: 0.8)                       │
│  • reflection_prompt: 反思提示模板                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2.5.5 TruthGate（真值门验证）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       TruthGate 验证流程                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输入: 推理结果                                                         │
│                                                                         │
│  验证维度:                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 逻辑一致性: 推理步骤是否自洽                                  │   │
│  │ 2. 事实准确性: 关键事实是否正确                                  │   │
│  │ 3. 完整性: 是否完整回答问题                                      │   │
│  │ 4. 相关性: 回答是否切题                                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  验证结果:                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ {                                                               │   │
│  │   "passed": true,                                               │   │
│  │   "confidence": 0.85,                                           │   │
│  │   "scores": {                                                   │   │
│  │     "logical_consistency": 0.9,                                 │   │
│  │     "factual_accuracy": 0.8,                                    │   │
│  │     "completeness": 0.85,                                       │   │
│  │     "relevance": 0.9                                            │   │
│  │   },                                                            │   │
│  │   "issues": [],                                                 │   │
│  │   "recommendations": []                                         │   │
│  │ }                                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  处理策略:                                                               │
│  • passed=true: 直接返回结果                                           │
│  • passed=false, confidence>=0.6: 返回结果 + 警告                      │
│  • passed=false, confidence<0.6: 触发重新推理                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2.5.6 神经符号知识图谱推理

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    神经符号融合推理架构                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  系统1: 神经感知引擎（相似性/模式识别）                                  │
│        ↑↓ 表征转换                                                      │
│  中间层: 概念提取/实体链接/规则编译                                      │
│        ↑↓ 表征转换                                                      │
│  系统2: 符号推理引擎（规则/约束/可解释）                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

| 推理类型 | 路由策略 | 适用场景 |
|---------|---------|---------|
| 演绎 | 符号优先 | 规则完备、可解释性强 |
| 归纳 | 神经优先 | 知识稀疏、统计信号强 |
| 类比 | 混合 | 跨域迁移 |
| 溯因 | 假设生成 | 根因分析 |

---

## 2.6 Memory Hub（记忆中心）

### 设计思路

统一记忆接口，治理知识条目，支持快速检索与复用。

### 记忆条目结构

```json
{
  "id": "mem-001",
  "content": "当工作流有超过5个并行任务时，使用批量执行策略可提升30%效率",
  "keywords": ["workflow", "parallel", "batch", "optimization"],
  "category": "Knowledge",
  "scope": "project",
  "via": "discovery",
  "title": "并行任务批量执行优化",
  "confidence": 0.9,
  "source": "log_analysis",
  "created_at": 1703275200,
  "updated_at": 1703275200,
  "evidence_ids": ["ev-001", "ev-002"],
  "trace_id": "tr-001"
}
```

### 记忆类型

| 类型 | 说明 | 示例 |
|------|------|------|
| Knowledge | 知识条目 | 最佳实践、模式、规则 |
| Rule | 规则约束 | 禁止操作、限制条件 |
| Experience | 经验总结 | 失败教训、成功经验 |

### 索引与检索

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        记忆检索流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输入: 检索请求                                                         │
│  {                                                                      │
│    "keywords": ["workflow", "optimization"],                           │
│    "scope": "project",                                                  │
│    "category": "Knowledge",                                             │
│    "limit": 10                                                          │
│  }                                                                      │
│                                                                         │
│  检索流程:                                                               │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 1. 关键词匹配 → 倒排索引                                          │  │
│  │ 2. 范围过滤 → scope, category                                    │  │
│  │ 3. 相关性排序 → TF-IDF + 置信度                                  │  │
│  │ 4. 返回结果 → 摘要 + 完整内容链接                                │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  输出: 检索结果                                                         │
│  {                                                                      │
│    "results": [                                                         │
│      {                                                                  │
│        "id": "mem-001",                                                 │
│        "title": "并行任务批量执行优化",                                 │
│        "summary": "当工作流有超过5个并行任务时...",                     │
│        "relevance": 0.95                                                │
│      }                                                                  │
│    ],                                                                   │
│    "total": 1,                                                          │
│    "trace_id": "tr-001"                                                 │
│  }                                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 记忆置信度与上下文指纹

| 字段 | 说明 | 用途 |
|------|------|------|
| context_fingerprint | 上下文指纹 | 检索时匹配场景相似度 |
| access_count | 访问次数 | 记忆价值评估 |
| last_accessed | 最近访问时间 | 衰减与遗忘判定 |
| decay_score | 衰减分数 | 触发归档/删除 |
| version | 版本号 | 冲突与回滚 |
| conflicts | 冲突记录 | 人工裁决入口 |
| modality | 模态类型 | 多模态检索 |
| embedding_ref | 向量引用 | 跨模态检索 |

### 上下文漂移与检索重排

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   上下文漂移检测与检索重排                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输入: query + 当前上下文                                                │
│  1. 计算上下文指纹与漂移分数                                             │
│  2. 若漂移分数超过阈值 → 重置检索策略                                    │
│  3. 重新排序 = 关键词 + 语义相似 + 置信度 + 新近度                        │
│                                                                         │
│  relevance_score =                                                      │
│    0.4 * semantic_similarity                                            │
│  + 0.2 * keyword_match                                                  │
│  + 0.2 * confidence                                                     │
│  + 0.2 * recency_boost                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 记忆巩固与遗忘循环

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       记忆巩固与遗忘流程                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  短期记忆 → 模式提取 → 冲突检测 → 长期沉淀                                │
│        │                         │                                       │
│        ├──────────低价值/过期─────┘                                       │
│        ▼                                                                 │
│     归档/删除                                                            │
│                                                                         │
│  触发策略:                                                               │
│  • 周期性批处理（每日/每周）                                             │
│  • 关键任务完成后触发                                                   │
│  • 访问衰减触发                                                         │
│                                                                         │
│  遗忘规则:                                                               │
│  • 超过阈值未访问且置信度低                                             │
│  • 与高可信记忆冲突且未被验证                                           │
│  • 时效性过期                                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 冲突检测与版本控制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    记忆版本控制与冲突处理                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  新记忆写入 → 与现有记忆一致性校验                                       │
│          │                                                             │
│          ├── 一致 → version +1                                          │
│          │                                                             │
│          └── 冲突 → 记录conflict + 进入人工裁决队列                       │
│                                                                         │
│  冲突证据: trace_id / source / evidence_ids                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 多模态记忆支持

| 能力 | 说明 | 用途 |
|------|------|------|
| 统一嵌入空间 | 文本/图像/音频同域表示 | 跨模态检索 |
| 跨模态召回 | 以文搜图/以图搜文 | 复杂任务检索 |
| 模态迁移 | 低样本模态共享知识 | 训练成本下降 |

### 自适应缓存与分层存储

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    自适应缓存反馈控制                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  工作负载特征 → 策略选择器 → 缓存执行器 → 反馈收集                         │
│                                                                         │
│  局部性指标:                                                             │
│  • 时间局部性强度 (TLI)                                                  │
│  • 空间局部性强度 (SLI)                                                  │
│  • 流行度偏度 (Zipf系数)                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

| 缓存层 | 策略 | 目标 |
|------|------|------|
| 热缓存 | LRU/自适应 | 降低延迟 |
| 温缓存 | LFU/自适应 | 提升命中率 |
| 冷存储 | 分层归档 | 降低成本 |

---

## 2.7 Growth Loop（成长循环）

### 设计思路

利用Agent空闲时间进行自主学习，实现能力沉淀与技能增长。

### 空闲学习触发机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       空闲学习触发流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  触发条件:                                                               │
│  • Agent 状态为 IDLE                                                    │
│  • 空闲时间 >= idle_timeout_ms (默认: 60000ms)                          │
│  • 队列深度 < 阈值                                                      │
│                                                                         │
│  学习流程:                                                               │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                                                                  │  │
│  │   ┌──────────┐    ┌──────────┐    ┌──────────┐                  │  │
│  │   │ 空闲检测 │───▶│ 日志分析 │───▶│ 模式提取 │                  │  │
│  │   └──────────┘    └──────────┘    └──────────┘                  │  │
│  │                                         │                        │  │
│  │                                         ▼                        │  │
│  │                                  ┌──────────┐                    │  │
│  │                                  │ 知识生成 │                    │  │
│  │                                  └────┬─────┘                    │  │
│  │                                       │                          │  │
│  │                                       ▼                          │  │
│  │                                  ┌──────────┐                    │  │
│  │                                  │ 自我验证 │                    │  │
│  │                                  └────┬─────┘                    │  │
│  │                                       │                          │  │
│  │                               通过 ───┼─── 失败                   │  │
│  │                               │       │       │                  │  │
│  │                               ▼       │       ▼                  │  │
│  │                        ┌──────────┐   │  ┌──────────┐            │  │
│  │                        │ 技能注册 │   │  │ 丢弃    │            │  │
│  │                        │ 记忆沉淀 │   │  └──────────┘            │  │
│  │                        └──────────┘   │                          │  │
│  │                                       │                          │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  学习约束:                                                               │
│  • 高风险变更必须审批                                                   │
│  • 学习产物必须可回滚                                                   │
│  • 新技能先小流量试运行                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 学习报告结构

```json
{
  "report_id": "lr-001",
  "agent_id": "a-001",
  "summary": "learned patterns from workflow execution",
  "new_skills": [
    {
      "skill_id": "skill-x",
      "name": "Workflow Optimization",
      "description": "Optimizes workflow execution order",
      "confidence": 0.85,
      "evidence_ids": ["ev-001", "ev-002"]
    }
  ],
  "memory_delta": [
    {
      "memory_id": "m-1",
      "type": "pattern",
      "content": "When workflow has >5 parallel tasks, use batch execution",
      "confidence": 0.9,
      "source": "log_analysis"
    }
  ],
  "validation": {
    "self_test_passed": true,
    "test_cases": 10,
    "test_passed": 9,
    "test_failed": 1
  },
  "rollback_info": {
    "snapshot_id": "snap-001",
    "can_rollback": true,
    "rollback_steps": ["unregister_skill:skill-x", "remove_memory:m-1"]
  }
}
```

### 元认知自改进机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      双层认知与自改进循环                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  认知层: 感知 → 推理 → 决策 → 行动                                      │
│  元认知层: 监控 → 评估 → 调节 → 学习                                    │
│                                                                         │
│  触发信号:                                                              │
│  • 置信度低/不确定性高                                                  │
│  • 预测误差超阈值                                                      │
│  • 新模式检测                                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

| 时间尺度 | 学习类型 | 触发条件 |
|---------|---------|---------|
| 即时 | 在线适应 | 单次预测误差 |
| 短期 | 批量更新 | 累积误差超阈值 |
| 中期 | 策略优化 | 性能指标下降 |
| 长期 | 架构演化 | 持续性能瓶颈 |

---

## 2.8 Risk Scorer（风险评分器）

### 设计思路

在执行前评估操作风险，高风险操作必须进入审批流程。

### 风险因子与权重

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        风险因子权重表                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  因子                    │ 权重范围 │ 说明                              │
│  ───────────────────────┼─────────┼──────────────────────────────────  │
│  文件改动范围            │ +0~30   │ 大范围/敏感目录操作               │
│  网络访问                │ +0~20   │ 外网/未信任域访问                 │
│  权限升级                │ +0~30   │ sudo/系统级操作                   │
│  破坏性操作              │ +0~20   │ 删除/覆盖/不可逆操作              │
│  资源占用                │ +0~10   │ 高CPU/内存/长时阻塞               │
│                                                                         │
│  总分: risk_score ∈ [0, 100]                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 风险决策矩阵

| 风险分数 | 决策 | 动作 |
|---------|------|------|
| < 30 | 允许 | 直接执行 |
| 30-60 | 警告 | 执行 + 审计记录 |
| ≥ 60 | 阻断 | 进入审批流程 |

### 风险审批流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        风险审批流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  审批请求:                                                               │
│  {                                                                      │
│    "approval_id": "apr-001",                                            │
│    "task_id": "t-889",                                                  │
│    "risk_score": 0.8,                                                   │
│    "risk_factors": [                                                    │
│      {"factor": "data_modification", "score": 0.5},                    │
│      {"factor": "external_api_call", "score": 0.3}                     │
│    ],                                                                   │
│    "requester": {"agent_id": "a-001", "trace_id": "tr-001"},           │
│    "status": "pending",                                                 │
│    "expires_at": 1703275800                                             │
│  }                                                                      │
│                                                                         │
│  审批响应:                                                               │
│  {                                                                      │
│    "approval_id": "apr-001",                                            │
│    "decision": "approved",                                              │
│    "approver": "human-001",                                             │
│    "reason": "Verified with team, safe to proceed",                    │
│    "conditions": ["Enable dry-run mode first"],                        │
│    "signed_at": 1703275300,                                             │
│    "signature": "sha256:abc123..."                                      │
│  }                                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2.9 Eval Gate（评估门）

### 设计思路

在关键节点进行离线评估，确保方案质量达标。

### 评估协议

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         评估协议结构                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输入:                                                                   │
│  • 快照 (snapshot)                                                      │
│  • 日志 (logs)                                                          │
│  • 指标 (metrics)                                                       │
│  • 变更清单 (changes)                                                   │
│                                                                         │
│  评估指标:                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • accuracy: 准确性                                               │   │
│  │ • coverage: 覆盖率                                               │   │
│  │ • performance: 性能                                              │   │
│  │ • stability: 稳定性                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  决策矩阵:                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • pass: 满足全部阈值                                             │   │
│  │ • warn: 部分阈值轻微不足，允许继续                               │   │
│  │ • block: 关键阈值不足，触发修复流程                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  输出:                                                                   │
│  {                                                                      │
│    "decision": "pass | warn | block",                                  │
│    "evidence": [...],                                                   │
│    "recommendation": "..."                                              │
│  }                                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 多时间尺度评估

| 维度 | 周期 | 目标 | 动作 |
|------|------|------|------|
| 短期 | 每次任务 | 内部一致性 | 触发TruthGate与快速回滚 |
| 中期 | 每日/每周 | 质量趋势 | 漂移检测与阈值调整 |
| 长期 | 月度/季度 | 外部基准对齐 | 对标评估与策略更新 |

### 对抗性自检与交叉验证

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   对抗性自检与交叉验证流程                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 生成对抗样本或逆向问题                                               │
│  2. 多策略独立推理并对比结果                                             │
│  3. 若结果冲突 → 标记高风险并进入人工审核                                │
│                                                                         │
│  目标:                                                                  │
│  • 识别隐藏缺陷与伪高分结果                                              │
│  • 提升系统对异常模式的鲁棒性                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 外部基准与灰度验证

| 类型 | 方式 | 说明 |
|------|------|------|
| 外部基准 | 定期对标 | 与公开基准或历史最佳模型对齐 |
| 灰度流量 | 影子流量 | 新策略不影响主结果 |
| A/B 实验 | 分流对比 | 结果优劣量化 |

### 自监督质量评估扩展

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    自监督质量评估闭环                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输出结果 → 自监督编码 → 置信度估计 → 一致性检查 → 校准 → 评估结果        │
│       ↑                                                            ↓    │
│    反馈样本  ← 人工反馈/行为反馈/自反馈  ← 结果决策                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

| 组件 | 作用 | 产出 |
|------|------|------|
| 不确定性量化 | 预测熵/集成 | 风险信号 |
| 自一致性 | 多样本一致性 | 置信度校验 |
| 置信度校准 | 温度缩放/等渗回归 | 校准概率 |
| 反馈写回 | 记忆与样本沉淀 | 增量学习触发 |

---

## 2.10 Auth & RBAC（认证与权限）

### JWT Claims 结构

```json
{
  "iss": "openclaw-x",
  "sub": "user-001",
  "aud": "api.openclaw-x.io",
  "exp": 1703275800,
  "iat": 1703275200,
  "roles": ["admin", "operator"],
  "tenant": "tenant-001",
  "scopes": ["read", "write", "exec"]
}
```

### RBAC 策略矩阵

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        RBAC 权限矩阵                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  资源:                                                                   │
│  • orchestrator.dag                                                     │
│  • risk.scorer                                                          │
│  • eval.gate                                                            │
│  • memory.entry                                                         │
│  • skills.registry                                                      │
│  • config.version                                                       │
│                                                                         │
│  动作:                                                                   │
│  • read: 读取                                                           │
│  • write: 写入                                                          │
│  • exec: 执行                                                           │
│  • approve: 审批                                                        │
│  • audit: 审计                                                          │
│                                                                         │
│  角色-权限映射:                                                          │
│  ┌─────────────┬───────┬───────┬───────┬─────────┬───────┐            │
│  │ 角色        │ read  │ write │ exec  │ approve │ audit │            │
│  ├─────────────┼───────┼───────┼───────┼─────────┼───────┤            │
│  │ admin       │   ✓   │   ✓   │   ✓   │    ✓    │   ✓   │            │
│  │ operator    │   ✓   │   ✓   │   ✓   │    -    │   ✓   │            │
│  │ viewer      │   ✓   │   -   │   -   │    -    │   ✓   │            │
│  │ auditor     │   ✓   │   -   │   -   │    -    │   ✓   │            │
│  └─────────────┴───────┴───────┴───────┴─────────┴───────┘            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2.11 Config & Rollback（配置与回滚）

### 配置 Schema

```json
{
  "version": "v1.0.0",
  "updated_at": 1703275200,
  "flags": {
    "enable_tot": true,
    "enable_reflexion": true,
    "enable_self_consistency": false
  },
  "modules": {
    "scheduler": {"max_concurrent": 10},
    "orchestrator": {"default_timeout_ms": 300000},
    "reasoning": {"default_strategy": "cot"}
  },
  "limits": {
    "max_retries": 3,
    "max_queue_depth": 1000
  }
}
```

### Feature Flags 结构

```json
{
  "flag_key": "enable_tot",
  "scope": "user | tenant | env",
  "rule": "user.role == 'admin'",
  "default": false
}
```

### 回滚操作

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         回滚操作流程                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  触发: rollback.sh version=v0.9.0                                       │
│                                                                         │
│  流程:                                                                   │
│  1. 验证目标版本存在                                                    │
│  2. 创建当前版本快照                                                    │
│  3. 加载目标版本配置                                                    │
│  4. 执行健康验证                                                        │
│  5. 更新版本标记                                                        │
│  6. 记录审计日志                                                        │
│                                                                         │
│  验收:                                                                   │
│  • 回滚时间 ≤ 10 分钟                                                   │
│  • 健康验证通过                                                         │
│  • 审计日志完整                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2.12 Observability（可观测性）

### 日志规范

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         日志字段规范                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  必需字段:                                                               │
│  • timestamp: 时间戳                                                    │
│  • level: 日志级别 (DEBUG/INFO/WARN/ERROR)                             │
│  • run_id: 运行ID                                                       │
│  • trace_id: 追踪ID                                                     │
│  • node_id: 节点ID                                                      │
│  • action: 操作类型                                                     │
│  • status: 状态 (success/failure)                                      │
│  • latency_ms: 延迟                                                     │
│  • error_code: 错误码                                                   │
│  • message: 消息                                                        │
│                                                                         │
│  分类:                                                                   │
│  • kernel: 内核日志                                                     │
│  • orchestrator: 编排日志                                               │
│  • auth: 认证日志                                                       │
│  • config: 配置日志                                                     │
│  • risk: 风险日志                                                       │
│  • eval: 评估日志                                                       │
│  • skills: 技能日志                                                     │
│                                                                         │
│  采样策略:                                                               │
│  • 错误: 全量采样                                                       │
│  • 高频动作: 1:N 采样                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 核心指标

| 指标 | 说明 | 采样 |
|------|------|------|
| latency_ms | 延迟 (p50/p90/p99) | 全量 |
| error_rate | 错误率 | 全量 |
| success_rate | 成功率 | 全量 |
| queue_depth | 队列深度 | 定时 |
| retry_count | 重试次数 | 全量 |

### Trace/Span/Context 追踪模型

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Trace-Span 结构                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Trace: 一次请求的完整链路                                              │
│  Span: 链路中的一次操作                                                  │
│  Context: 追踪上下文传播载体                                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 上下文传播协议

| 协议 | 传播方式 |
|------|---------|
| HTTP | traceparent/tracestate Header |
| gRPC | Metadata |
| Kafka | Message Header |
| MQ | Property/User Property |

### 采样策略

| 策略 | 描述 | 场景 |
|------|------|------|
| 头部采样 | 请求入口决定 | 低流量 |
| 尾部采样 | 请求结束决定 | 异常保留 |
| 自适应采样 | 动态调整 | 高波动 |

### OpenTelemetry 集成

```
┌─────────────────────────────────────────────────────────────────────────┐
│  SDK/Agent → Collector(Receiver/Processor/Exporter) → Storage/BI        │
└─────────────────────────────────────────────────────────────────────────┘
```

### 健康契约

```
/healthz → {ok: true, version: "1.0.0", last_update: 1703275200}
/readyz  → {ok: true, dependencies: {db: true, cache: true}}
```

### 2.12.1 熵增控制（Anti-Entropy Governance）

**熵源定义**

- 输入熵：任务/资料进入时命名、归属、版本与目的不清
- 演化熵：重复文件、临时结论散落、旧结论未标废
- 可观测性熵：进度汇报不结构化、关键决策无留痕

**不可破坏约束（Invariants）**

- 任务唯一真源：一个任务对应唯一产出、唯一归档位置、唯一结论摘要
- 产出可追溯：关键决策可回溯背景、备选与影响
- 熵清扫制度化：固定节律清理、合并、标废

**机制构件**

- 任务状态机：Draft → Ready → Doing → Blocked → Review → Done → Archived
- 结构化汇报：完成 / 下周期 / 阻塞 / 风险 / 信心等级
- Deliverable 卡：一句话产出、适用范围、关键结论、版本日期、关联 ADR
- ADR 记录：背景、决策、备选、影响、负责人、日期
- 强目录 + 弱索引：归档位置强约束，索引与入口弱关联

**触发与闭环**

- 状态变更触发汇报与审计事件
- Done → Archived 需满足 Deliverable + ADR + Index 完整
- 每周“熵清扫”窗口执行清空 Inbox、合并重复、标废过期结论

**熵指标**

- 检索时间（分钟级均值）
- Inbox 滞留（>7天未处理条目数）
- 无入口产出（未被索引引用）
- 重复率（同主题多版本无唯一真源）
- 返工率（信息找不到/版本错用导致的返工）

**落地代码**

- core/governance/entropy_control.py

### 2.12.2 熵增管理 V2（Enhanced Entropy Governance）

**设计思路**

原有熵增控制存在以下瓶颈：
- 单一维度熵度量，无法定位熵源根源
- 被动式清扫，无自动执行与优先级排序
- 无实时预警，无法发现熵增趋势
- 内存存储，重启丢失
- 无并发控制

V2 版本实现分层熵管理架构，包含六大核心模块：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    熵增管理 V2 架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     EntropyEngine (统一入口)                      │   │
│  │                                                                 │   │
│  │  record() → check_alerts() → get_report() → auto_sweep()       │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│       ┌──────────────────────┼──────────────────────┐                  │
│       │                      │                      │                  │
│       ▼                      ▼                      ▼                  │
│  ┌──────────┐         ┌──────────┐          ┌──────────┐              │
│  │Calculator│         │ Monitor  │          │ Sweeper  │              │
│  │  熵计算器 │         │ 预警监控  │          │ 清扫引擎  │              │
│  └──────────┘         └──────────┘          └──────────┘              │
│       │                      │                      │                  │
│       │              ┌───────┴───────┐              │                  │
│       ▼              ▼               ▼              ▼                  │
│  ┌──────────┐  ┌──────────┐   ┌──────────┐  ┌──────────┐             │
│  │Attributor│  │Adaptive  │   │Persistence│  │  Types   │             │
│  │ 归因分析 │  │ Threshold│   │  持久化    │  │ 基础类型 │             │
│  └──────────┘  └──────────┘   └──────────┘  └──────────┘             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**分层熵度量**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       熵值分层度量体系                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  熵级别 (EntropyLevel):                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ SYSTEM = 0      → 系统级熵（整体架构、依赖关系）                    │   │
│  │ MODULE = 1      → 模块级熵（组件间耦合、接口变化）                  │   │
│  │ COMPONENT = 2   → 组件级熵（函数复杂度、状态管理）                  │   │
│  │ FUNCTION = 3    → 函数级熵（代码复杂度、参数传递）                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  熵类别 (EntropyCategory):                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ INPUT          → 输入熵（命名不清、归属不明）                       │   │
│  │ EVOLUTION      → 演化熵（重复文件、旧结论未标废）                   │   │
│  │ OBSERVABILITY  → 可观测性熵（汇报不结构化、决策无留痕）             │   │
│  │ STRUCTURE      → 结构熵（配置漂移、依赖变更）                       │   │
│  │ BEHAVIOR       → 行为熵（错误率、延迟波动）                         │   │
│  │ DATA           → 数据熵（缓存失效、数据不一致）                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  时间衰减模型:                                                           │
│  decay(h) = e^(-ln(2) * h / half_life)                                │
│                                                                         │
│  加权熵计算:                                                             │
│  entropy = Σ(value_i * weight_i * decay_i) / Σ(weight_i * decay_i)    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**预警监控机制**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       预警规则与阈值管理                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  阈值等级:                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ INFO      < warning     → 正常状态                               │   │
│  │ WARNING   ≥ warning     → 需要关注                               │   │
│  │ CRITICAL  ≥ critical    → 需要立即处理                           │   │
│  │ EMERGENCY ≥ emergency   → 系统危急状态                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  默认阈值配置:                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Category        │ Warning │ Critical │ Emergency │ Weight       │   │
│  │ ─────────────────────────────────────────────────────────────── │   │
│  │ INPUT           │  0.30   │   0.60   │   0.80    │    1.0       │   │
│  │ EVOLUTION       │  0.40   │   0.70   │   0.90    │    1.2       │   │
│  │ OBSERVABILITY   │  0.35   │   0.65   │   0.85    │    0.8       │   │
│  │ STRUCTURE       │  0.25   │   0.50   │   0.75    │    1.1       │   │
│  │ BEHAVIOR        │  0.30   │   0.60   │   0.80    │    1.0       │   │
│  │ DATA            │  0.35   │   0.65   │   0.85    │    0.9       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  告警冷却: 同一规则在 cooldown_minutes 内不重复触发                       │
│  订阅机制: 支持 callback 订阅告警事件                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**熵清扫引擎**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     清扫策略与优先级管理                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  优先级排序:                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ CRITICAL  = 0   → 立即执行（影响系统可用性）                       │   │
│  │ HIGH      = 1   → 高优先级（影响核心功能）                         │   │
│  │ MEDIUM    = 2   → 中优先级（影响用户体验）                         │   │
│  │ LOW       = 3   → 低优先级（可延后处理）                           │   │
│  │ DEFERRED  = 4   → 延迟执行（定期批量处理）                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  预定义策略:                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ clear_stale_inbox  → 清理过期 Inbox 条目 (HIGH, auto)            │   │
│  │ index_unindexed    → 索引未索引输出 (MEDIUM, auto)               │   │
│  │ merge_duplicates   → 合并重复主题 (LOW, manual)                  │   │
│  │ cleanup_orphans    → 清理孤立资源 (MEDIUM, auto)                 │   │
│  │ compress_history   → 压缩历史数据 (DEFERRED, manual)             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  执行模式:                                                               │
│  • dry_run: 仅模拟，不实际执行                                           │
│  • batch: 批量执行多个动作                                               │
│  • parallel: 并行执行（可选）                                            │
│  • auto_sweep: 自动选择并执行高优先级清扫                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**趋势分析与归因**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     趋势分析与根源归因                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  趋势分析 (TrendAnalysis):                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • mean / std_dev     → 均值与标准差                              │   │
│  │ • min_val / max_val  → 极值                                      │   │
│  │ • slope              → 变化斜率 (per hour)                       │   │
│  │ • trend_direction    → increasing / decreasing / stable         │   │
│  │ • prediction_1h/24h  → 预测值                                    │   │
│  │ • confidence         → 置信度                                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  根源归因 (AttributionResult):                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • source             → 熵源标识                                  │   │
│  │ • contribution_ratio → 贡献占比                                  │   │
│  │ • absolute_value     → 绝对熵值                                  │   │
│  │ • trend_impact       → 趋势影响                                  │   │
│  │ • related_sources    → 关联熵源                                  │   │
│  │ • root_cause_hypothesis → 根因假设                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  相关性检测: Pearson 相关系数，识别熵源间的联动关系                        │
│  假设生成: 自动生成根因假设和调查建议                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**自适应阈值**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     自适应阈值调节机制                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  调节策略:                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 收集 baseline 样本 (min_samples=50)                           │   │
│  │ 2. 计算样本均值和标准差                                           │   │
│  │ 3. 根据基线偏移调整阈值                                           │   │
│  │ 4. 限制最大调整幅度 (max_adjustment_factor=0.3)                  │   │
│  │ 5. 确保阈值层级关系 (warning < critical < emergency)             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  调节间隔: adaptation_interval_hours (默认24小时)                        │
│  学习率: learning_rate (控制调整激进程度)                                 │
│  置信度: 基于样本量和稳定性计算                                           │
│                                                                         │
│  阈值调整记录:                                                           │
│  • old/new warning/critical/emergency                                   │
│  • reason: 调整原因描述                                                  │
│  • confidence: 调整置信度                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**持久化存储**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     SQLite 持久化层                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  数据表结构:                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ entropy_samples    → 熵样本时序数据                              │   │
│  │ entropy_alerts     → 告警记录                                    │   │
│  │ sweep_actions      → 清扫动作记录                                │   │
│  │ thresholds         → 阈值配置                                    │   │
│  │ adaptive_thresholds → 自适应阈值状态                             │   │
│  │ trend_analyses     → 趋势分析结果                                │   │
│  │ entropy_reports    → 熵报告历史                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  自动清理: max_records=100000，超过时按时间戳清理旧记录                    │
│  索引: timestamp, category, source 组合索引                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**核心接口**

```python
class EntropyEngine:
    def record(metric_name: str, value: float, source: str) -> EntropySample
    def check_alerts(category: EntropyCategory) -> List[EntropyAlert]
    def get_entropy(category, level, source) -> float
    def get_health_score() -> float
    def get_report() -> EntropyReport
    def plan_sweep(categories, auto_only) -> List[SweepAction]
    def execute_sweep(actions, dry_run) -> List[SweepExecutionResult]
    def auto_sweep(max_actions) -> List[SweepExecutionResult]
    def analyze_trend(category, source) -> TrendAnalysis
    def analyze_attribution(top_n) -> List[AttributionResult]
    def adapt_thresholds() -> List[ThresholdAdjustment]
    def start() -> None
    def stop() -> None

class EntropyCalculator:
    def record_sample(metric_name, value, source) -> EntropySample
    def compute_entropy(category, level, source, since) -> float
    def compute_by_category(since) -> Dict[EntropyCategory, float]
    def compute_by_level(since) -> Dict[EntropyLevel, float]
    def compute_total_entropy(since) -> float
    def compute_health_score(since) -> float
    def get_top_contributors(top_n, since) -> List[AttributionResult]

class EntropyMonitor:
    def check_and_alert(category) -> List[EntropyAlert]
    def acknowledge_alert(alert_id, acknowledged_by) -> EntropyAlert
    def get_active_alerts(severity, category) -> List[EntropyAlert]
    def analyze_trend(category, source) -> TrendAnalysis
    def generate_report() -> EntropyReport

class EntropySweeper:
    def plan_sweep(categories, auto_only) -> List[SweepAction]
    def prioritize_actions(actions, max_actions) -> List[SweepAction]
    def execute_action(action, dry_run) -> SweepExecutionResult
    def execute_batch(actions, parallel, stop_on_failure) -> List[SweepExecutionResult]
    def auto_sweep(max_actions) -> List[SweepExecutionResult]

class EntropyAttributor:
    def analyze(top_n, include_correlations) -> List[AttributionResult]
    def generate_hypotheses() -> List[RootCauseHypothesis]
    def get_correlations(source, min_correlation) -> List[CorrelationResult]
```

**落地代码**

- core/governance/entropy_v2/base_types.py    → 基础类型定义
- core/governance/entropy_v2/calculator.py    → 熵值计算器
- core/governance/entropy_v2/monitor.py       → 预警监控
- core/governance/entropy_v2/sweeper.py       → 清扫引擎
- core/governance/entropy_v2/attribution.py   → 归因分析
- core/governance/entropy_v2/adaptive_threshold.py → 自适应阈值
- core/governance/entropy_v2/persistence.py   → 持久化存储
- core/governance/entropy_v2/engine.py        → 统一入口
- core/governance/entropy_v2/__init__.py      → 模块导出
- core/governance/entropy_v2/test_entropy_v2.py → 单元测试 (41个测试用例)

**验收标准**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    熵增管理 V2 验收标准                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  功能完整性:                                                             │
│  • 支持分层熵度量 (4级 × 6类 = 24个维度)                                 │
│  • 支持实时预警与告警订阅                                                │
│  • 支持趋势分析与预测                                                    │
│  • 支持根源归因与假设生成                                                │
│  • 支持自适应阈值调节                                                    │
│  • 支持SQLite持久化                                                      │
│  • 支持并发安全 (RLock)                                                  │
│                                                                         │
│  性能指标:                                                               │
│  • 样本记录延迟 < 1ms                                                    │
│  • 熵值计算延迟 < 5ms (1000样本)                                         │
│  • 告警检查延迟 < 10ms                                                   │
│  • 趋势分析延迟 < 50ms                                                   │
│  • 清扫执行延迟取决于具体策略                                            │
│                                                                         │
│  测试覆盖:                                                               │
│  • 41个单元测试全部通过                                                  │
│  • 覆盖 Calculator/Monitor/Sweeper/Attributor/Adaptive/Persistence/Engine │
│  • 包含并发安全测试                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2.13 Multi-Model Hub（多模型中心）

### 设计思路

OpenClaw-X 需要同时支持多个大语言模型在线运行，实现模型间的智能路由、负载均衡与故障转移。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      多模型中心架构                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Model Registry (模型注册中心)                 │   │
│  │                                                                 │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐   │   │
│  │  │  GPT-4    │  │ Claude-3  │  │  Gemini   │  │  Local    │   │   │
│  │  │  Provider │  │  Provider │  │  Provider │  │  Provider │   │   │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘   │   │
│  │        │              │              │              │          │   │
│  └────────┼──────────────┼──────────────┼──────────────┼──────────┘   │
│           │              │              │              │               │
│           └──────────────┴──────┬───────┴──────────────┘               │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Intelligent Router (智能路由器)                │   │
│  │                                                                 │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │  Complexity  │  │   Model      │  │   Routing    │          │   │
│  │  │  Estimator   │  │   Scorer     │  │   Decision   │          │   │
│  │  │  复杂度评估  │  │   模型评分   │  │   路由决策   │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Load Balancer (负载均衡器)                     │   │
│  │                                                                 │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │ Round Robin  │  │Weighted RR   │  │Least Conn    │          │   │
│  │  │ 轮询         │  │加权轮询      │  │最少连接      │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Failover Manager (故障转移)                    │   │
│  │                                                                 │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │Health Checker│  │Circuit Breaker│ │  Fallback    │          │   │
│  │  │健康检查      │  │熔断器        │  │故障切换      │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 模型元数据

```json
{
  "model_id": "gpt-4-turbo",
  "provider": "openai",
  "model_name": "gpt-4-turbo-preview",
  "display_name": "GPT-4 Turbo",
  
  "capabilities": {
    "supports_streaming": true,
    "supports_functions": true,
    "supports_vision": true,
    "supports_audio": false,
    "supports_json_mode": true,
    "max_context_tokens": 128000,
    "max_output_tokens": 4096,
    "reasoning_score": 0.95,
    "coding_score": 0.92,
    "creative_score": 0.88,
    "analysis_score": 0.93
  },
  
  "performance": {
    "avg_latency_ms": 2500,
    "p50_latency_ms": 2000,
    "p95_latency_ms": 5000,
    "p99_latency_ms": 8000,
    "success_rate": 0.995,
    "tokens_per_second": 45
  },
  
  "pricing": {
    "input_price_per_1k": 0.01,
    "output_price_per_1k": 0.03
  },
  
  "config": {
    "api_key_env": "OPENAI_API_KEY",
    "base_url": "https://api.openai.com/v1",
    "timeout_ms": 60000,
    "max_retries": 3
  },
  
  "status": "enabled",
  "weight": 1.0,
  "priority": 5
}
```

### 智能路由流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        智能路由决策流程                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输入: 用户请求 + 上下文                                                │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Step 1: 复杂度评估                                               │  │
│  │                                                                  │  │
│  │  评估维度:                                                        │  │
│  │  • length: 输入长度因子 (0-1)                                    │  │
│  │  • structure: 结构复杂度 (列表/条件/步骤)                        │  │
│  │  • reasoning: 推理关键词密度                                     │  │
│  │  • domain: 领域专业性 (代码/数学/创意)                           │  │
│  │  • context: 上下文复杂度                                         │  │
│  │                                                                  │  │
│  │  输出: ComplexityScore { overall, level, confidence }           │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Step 2: 任务分类                                                 │  │
│  │                                                                  │  │
│  │  任务类型:                                                        │  │
│  │  • coding: 代码生成/调试                                         │  │
│  │  • reasoning: 逻辑推理/分析                                      │  │
│  │  • creative: 创意写作                                            │  │
│  │  • math: 数学计算                                                │  │
│  │  • general: 通用任务                                             │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Step 3: 模型评分                                                 │  │
│  │                                                                  │  │
│  │  评分维度:                                                        │  │
│  │  • quality_score: 质量评分 (能力匹配度)                          │  │
│  │  • cost_score: 成本评分 (价格竞争力)                             │  │
│  │  • latency_score: 延迟评分 (响应速度)                            │  │
│  │  • load_score: 负载评分 (当前负载)                               │  │
│  │  • task_affinity: 任务亲和度 (领域专长)                          │  │
│  │                                                                  │  │
│  │  综合评分 = Σ(score_i × weight_i)                               │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Step 4: 路由决策                                                 │  │
│  │                                                                  │  │
│  │  决策输出:                                                        │  │
│  │  • selected_model: 选中的模型                                    │  │
│  │  • reason: 选择原因                                              │  │
│  │  • confidence: 决策置信度                                        │  │
│  │  • alternatives: 备选模型列表                                    │  │
│  │  • estimated_latency_ms: 预估延迟                                │  │
│  │  • estimated_cost: 预估成本                                      │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  输出: RoutingDecision                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 负载均衡策略

| 策略 | 说明 | 适用场景 |
|------|------|---------|
| Round Robin | 轮询分配 | 同质模型池 |
| Weighted Round Robin | 加权轮询 | 异构模型池 |
| Least Connections | 最少连接 | 长连接场景 |
| Least Latency | 最低延迟 | 延迟敏感型 |
| Random | 随机分配 | 测试场景 |

### 故障转移机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        故障转移流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  健康检查器 (Health Checker)                                      │  │
│  │                                                                  │  │
│  │  检查间隔: 30秒                                                   │  │
│  │  超时时间: 10秒                                                   │  │
│  │  失败阈值: 连续3次失败 → 标记不健康                               │  │
│  │  恢复阈值: 连续2次成功 → 标记健康                                 │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  熔断器 (Circuit Breaker)                                        │  │
│  │                                                                  │  │
│  │  状态机:                                                          │  │
│  │  ┌─────────┐    失败达阈值    ┌─────────┐                       │  │
│  │  │ CLOSED  │ ───────────────▶ │  OPEN   │                       │  │
│  │  │ (正常)  │                  │ (熔断)  │                       │  │
│  │  └─────────┘                  └────┬────┘                       │  │
│  │       ▲                            │                             │  │
│  │       │                            │ 超时后                                      │  │
│  │  成功达阈值                        │ 进入半开                                   │  │
│  │       │                            ▼                             │  │
│  │       │                      ┌─────────┐                        │  │
│  │       └──────────────────── │HALF_OPEN│                        │  │
│  │                              │ (半开)  │                        │  │
│  │                              └─────────┘                        │  │
│  │                                                                  │  │
│  │  配置:                                                            │  │
│  │  • failure_threshold: 5 (失败阈值)                               │  │
│  │  • success_threshold: 3 (恢复阈值)                               │  │
│  │  • timeout: 30秒 (熔断超时)                                      │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  故障切换 (Failover)                                              │  │
│  │                                                                  │  │
│  │  切换策略:                                                        │  │
│  │  1. 主模型失败 → 尝试备选模型                                     │  │
│  │  2. 备选模型失败 → 尝试其他可用模型                               │  │
│  │  3. 所有模型失败 → 返回降级响应                                   │  │
│  │                                                                  │  │
│  │  重试策略:                                                        │  │
│  │  • max_retry_attempts: 3                                         │  │
│  │  • retry_delay_ms: 100 (指数回退)                                │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 成本优化

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        成本优化策略                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 任务复杂度匹配:                                                     │
│     • 简单任务 → 轻量模型 (低成本)                                      │
│     • 复杂任务 → 高能力模型 (高成本)                                    │
│                                                                         │
│  2. 批量请求合并:                                                       │
│     • 合并相似请求减少API调用                                           │
│     • 缓存常见查询结果                                                  │
│                                                                         │
│  3. 动态定价感知:                                                       │
│     • 监控各模型价格变化                                                │
│     • 动态调整路由权重                                                  │
│                                                                         │
│  4. 预算控制:                                                           │
│     • 设置每日/每月预算上限                                             │
│     • 超预算自动降级                                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 核心接口

```python
class ModelRegistry:
    def register(model: ModelMetadata) -> bool
    def unregister(model_id: str) -> bool
    def get(model_id: str) -> ModelMetadata
    def get_available_models() -> List[ModelMetadata]
    def update_status(model_id: str, status: ModelStatus)
    def update_health(model_id: str, health: ModelHealth)

class ModelSelector:
    def select(request: RoutingRequest) -> RoutingDecision
    def select_fast(prompt: str, task_type: str) -> ModelMetadata
    def explain(request_id: str) -> Dict
    def set_strategy(strategy: str)

class LoadBalancer:
    def register_instance(instance_id: str, weight: float)
    def unregister_instance(instance_id: str)
    def select() -> str
    def record_request_start(instance_id: str)
    def record_request_end(instance_id: str, latency_ms: int, success: bool)

class FailoverManager:
    def register_instance(instance_id: str, health_check_handler: Callable)
    def unregister_instance(instance_id: str)
    def is_available(instance_id: str) -> bool
    def get_fallback(instance_id: str) -> str
    def execute_with_failover(instance_id: str, operation: Callable) -> Any
```

### 文件结构

```
code/
├── core/
│   └── model_hub/
│       ├── __init__.py
│       ├── model_metadata.py      # 模型元数据定义
│       ├── model_provider.py      # 模型提供者抽象
│       ├── registry.py            # 模型注册中心
│       │
│       ├── router/
│       │   ├── __init__.py
│       │   ├── complexity.py      # 复杂度评估器
│       │   ├── scoring.py         # 模型评分算法
│       │   └── selector.py        # 智能模型选择器
│       │
│       ├── load_balancer/
│       │   ├── __init__.py
│       │   ├── strategies.py      # 负载均衡策略
│       │   └── balancer.py        # 负载均衡器
│       │
│       └── failover/
│           ├── __init__.py
│           ├── health_checker.py  # 健康检查器
│           ├── circuit_breaker.py # 熔断器
│           └── failover_manager.py # 故障转移管理
```

### 验收标准

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    多模型中心验收标准                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  路由性能:                                                              │
│  • 路由决策延迟 < 10ms                                                  │
│  • 复杂度评估准确率 > 85%                                               │
│  • 任务分类准确率 > 90%                                                 │
│                                                                         │
│  负载均衡:                                                              │
│  • 请求分布偏差 < 10%                                                   │
│  • 故障检测时间 < 60秒                                                  │
│  • 故障切换时间 < 5秒                                                   │
│                                                                         │
│  可用性:                                                                │
│  • 单模型故障不影响整体服务                                             │
│  • 系统可用性 > 99.9%                                                   │
│  • 平均恢复时间 (MTTR) < 30秒                                           │
│                                                                         │
│  成本优化:                                                              │
│  • 简单任务成本节省 > 50%                                               │
│  • 资源利用率 > 80%                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2.14 Multi-Tenant Resource Isolation（多租户资源隔离）

### 设计思路

实现租户级别的资源隔离，支持配额池管理、租户限流和成本可追溯。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      多租户资源隔离架构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Tenant Manager (租户管理器)                    │   │
│  │                                                                 │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐   │   │
│  │  │  Tenant   │  │  Tenant   │  │  Tenant   │  │  Tenant   │   │   │
│  │  │    A      │  │    B      │  │    C      │  │    D      │   │   │
│  │  │  (高优)   │  │  (标准)   │  │  (试用)   │  │  (企业)   │   │   │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘   │   │
│  │        │              │              │              │          │   │
│  └────────┼──────────────┼──────────────┼──────────────┼──────────┘   │
│           │              │              │              │               │
│           └──────────────┴──────┬───────┴──────────────┘               │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Rate Limiter (限流器)                          │   │
│  │                                                                 │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │ Token Bucket │  │Sliding Window│  │ Fixed Window │          │   │
│  │  │ 令牌桶       │  │ 滑动窗口     │  │ 固定窗口     │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Quota Manager (配额管理)                       │   │
│  │                                                                 │   │
│  │  配额维度:                                                       │   │
│  │  • requests_per_minute/hour/day                                 │   │
│  │  • max_concurrent_tasks                                         │   │
│  │  • max_tokens_per_day                                           │   │
│  │  • cost_budget_daily/monthly                                    │   │
│  │  • max_storage_mb                                               │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Resource Pool (资源池)                         │   │
│  │                                                                 │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │   Pool A     │  │   Pool B     │  │   Pool C     │          │   │
│  │  │ (GPU/高优)   │  │ (CPU/标准)   │  │ (共享/试用)  │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 租户配额结构

```json
{
  "tenant_id": "tenant-abc123",
  "name": "Enterprise Customer A",
  "status": "active",
  
  "quota": {
    "max_requests_per_minute": 1000,
    "max_requests_per_hour": 50000,
    "max_requests_per_day": 500000,
    "max_concurrent_tasks": 50,
    "max_queue_depth": 500,
    "max_tokens_per_day": 10000000,
    "max_storage_mb": 10240,
    "max_agents": 20,
    "max_workflows": 100,
    "cost_budget_daily": 500.0,
    "cost_budget_monthly": 10000.0
  },
  
  "config": {
    "priority": "high",
    "enable_priority_queue": true,
    "enable_cost_tracking": true,
    "enable_audit_log": true,
    "data_retention_days": 90,
    "allowed_providers": ["openai", "anthropic"],
    "blocked_features": []
  }
}
```

### 核心接口

```python
class TenantManager:
    def create_tenant(name: str, quota: TenantQuota, config: TenantConfig) -> Tenant
    def get_tenant(tenant_id: str) -> Tenant
    def update_tenant(tenant_id: str, **kwargs) -> bool
    def suspend_tenant(tenant_id: str) -> bool
    def check_tenant_quota(tenant_id: str, resource: str) -> (bool, str)

class RateLimiter:
    def check(key: str, policy_name: str) -> RateLimitResult
    def check_tenant(tenant_id: str, policies: List[str]) -> Dict[str, RateLimitResult]
    def reset(key: str, policy_name: str)

class QuotaManager:
    def set_quota(tenant_id: str, resource_type: str, limit: float, period: str)
    def consume(tenant_id: str, resource_type: str, amount: float) -> (bool, QuotaUsage)
    def reserve(tenant_id: str, resource_type: str, amount: float) -> QuotaReservation
    def get_utilization_report(tenant_id: str) -> Dict

class ResourcePool:
    def allocate(tenant_id: str, amount: float) -> Allocation
    def release(allocation_id: str) -> bool
    def get_utilization() -> float
```

---

## 2.15 Multi-Tier Caching（多级缓存系统）

### 设计思路

实现L1本地缓存+L2分布式缓存的多级架构，支持失效广播和一致性保证。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        多级缓存架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   L1 Local Cache (本地缓存)                      │   │
│  │                                                                 │   │
│  │  特性:                                                          │   │
│  │  • 进程内内存缓存                                               │   │
│  │  • TTL过期策略                                                  │   │
│  │  • LRU/LFU淘汰策略                                              │   │
│  │  • 标签索引支持批量失效                                         │   │
│  │                                                                 │   │
│  │  配置示例:                                                      │   │
│  │  • max_entries: 10000                                          │   │
│  │  • max_size_bytes: 100MB                                       │   │
│  │  • default_ttl_seconds: 300                                    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                           Miss/Read-Through                            │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   L2 Distributed Cache (分布式缓存)              │   │
│  │                                                                 │   │
│  │  特性:                                                          │   │
│  │  • 跨节点共享缓存                                               │   │
│  │  • 版本号支持CAS操作                                            │   │
│  │  • 节点标识追踪                                                 │   │
│  │  • Checksum校验                                                 │   │
│  │                                                                 │   │
│  │  配置示例:                                                      │   │
│  │  • default_ttl_seconds: 3600                                   │   │
│  │  • max_key_size: 1KB                                           │   │
│  │  • max_value_size: 10MB                                        │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                          失效广播                                       │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Invalidation Broadcaster (失效广播)            │   │
│  │                                                                 │   │
│  │  失效类型:                                                       │   │
│  │  • KEY: 单键失效                                                │   │
│  │  • TAG: 标签批量失效                                            │   │
│  │  • PREFIX: 前缀批量失效                                         │   │
│  │  • ALL: 全局失效                                                │   │
│  │                                                                 │   │
│  │  事件传播:                                                       │   │
│  │  • Pub/Sub消息队列                                              │   │
│  │  • 事件去重处理                                                 │   │
│  │  • 源节点过滤                                                   │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 缓存策略

| 策略 | 说明 | 适用场景 |
|------|------|---------|
| Read-Through | 读取时自动回填 | 热点数据 |
| Write-Through | 写入时同步更新 | 强一致性 |
| Write-Behind | 写入异步更新 | 高吞吐 |
| Refresh-Ahead | 预刷新过期数据 | 低延迟 |

### 核心接口

```python
class MultiTierCacheManager:
    def get(key: str) -> Any
    def set(key: str, value: Any, ttl_seconds: int, tags: List[str])
    def delete(key: str) -> bool
    def invalidate(key: str)
    def invalidate_by_tag(tag: str)
    def invalidate_by_prefix(prefix: str)
    def get_or_set(key: str, loader: Callable, ttl_seconds: int) -> Any
    def get_stats() -> MultiTierStats
```

---

## 2.16 Error Pattern Learning（错误模式学习）

### 设计思路

实现错误模式注册、反模式检测和失败样本学习闭环。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        错误模式学习架构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Error Pattern Registry (错误模式注册)          │   │
│  │                                                                 │   │
│  │  模式匹配:                                                       │   │
│  │  • 关键词匹配 (keywords)                                        │   │
│  │  • 正则表达式 (signature_patterns)                              │   │
│  │  • 上下文条件 (context)                                         │   │
│  │                                                                 │   │
│  │  分类维度:                                                       │   │
│  │  • Category: timeout/rate_limit/network/logic/...              │   │
│  │  • Severity: low/medium/high/critical                          │   │
│  │  • Auto-recoverable: true/false                                │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Anti-Pattern Detector (反模式检测)             │   │
│  │                                                                 │   │
│  │  预置反模式:                                                     │   │
│  │  • God Object (上帝对象)                                        │   │
│  │  • Spaghetti Code (面条代码)                                    │   │
│  │  • Premature Optimization (过早优化)                            │   │
│  │  • Copy-Paste Programming (复制粘贴编程)                        │   │
│  │  • Big Ball of Mud (大泥球)                                     │   │
│  │                                                                 │   │
│  │  检测输出:                                                       │   │
│  │  • Detection location                                           │   │
│  │  • Remediation suggestions                                      │   │
│  │  • Severity & Confidence                                        │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Failure Analyzer (失败分析器)                  │   │
│  │                                                                 │   │
│  │  分析维度:                                                       │   │
│  │  • 按组件统计 (by_component)                                    │   │
│  │  • 按类型统计 (by_type)                                         │   │
│  │  • 时间分布 (by_hour)                                           │   │
│  │  • Top失败模式 (top_failures)                                   │   │
│  │                                                                 │   │
│  │  报告输出:                                                       │   │
│  │  • MTTR (平均恢复时间)                                          │   │
│  │  • MTBF (平均故障间隔)                                          │   │
│  │  • 改进建议 (recommendations)                                   │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Learning Queue (学习队列)                      │   │
│  │                                                                 │   │
│  │  任务类型:                                                       │   │
│  │  • ERROR_ANALYSIS: 错误分析                                     │   │
│  │  • PATTERN_LEARNING: 模式学习                                   │   │
│  │  • SKILL_IMPROVEMENT: 技能改进                                  │   │
│  │  • KNOWLEDGE_EXTRACTION: 知识提取                               │   │
│  │  • FEEDBACK_INTEGRATION: 反馈整合                               │   │
│  │                                                                 │   │
│  │  处理流程:                                                       │   │
│  │  失败样本 → 队列入队 → Worker处理 → 学习结果 → 知识库更新       │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 核心接口

```python
class ErrorPatternRegistry:
    def register_pattern(pattern: ErrorPattern) -> bool
    def record_error(error_message: str, context: Dict) -> ErrorInstance
    def get_pattern(pattern_id: str) -> ErrorPattern
    def get_top_patterns(limit: int) -> List[ErrorPattern]

class AntiPatternDetector:
    def detect(code_or_config: str, location: str) -> List[Detection]
    def get_pattern(pattern_id: str) -> AntiPattern
    def acknowledge_detection(detection_id: str) -> bool

class FailureAnalyzer:
    def record(component: str, operation: str, error: str) -> FailureEvent
    def analyze(hours: int) -> FailureReport
    def set_resolution(event_id: str, root_cause: str, resolution: str)

class LearningQueue:
    def submit(task_type: TaskType, source: str, input_data: Any) -> LearningTask
    def submit_from_error(error_instance: ErrorInstance) -> LearningTask
    def start()
    def stop()
```

---

## 2.17 Quality Feedback Loop（质量评估反馈闭环）

### 设计思路

实现离线评测集、线上指标监控、用户反馈收集和策略灰度发布。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        质量评估反馈闭环架构                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Quality Evaluator (质量评估器)                 │   │
│  │                                                                 │   │
│  │  评估指标:                                                       │   │
│  │  • Accuracy: 准确率                                             │   │
│  │  • Precision/Recall/F1: 精确率/召回率/F1                        │   │
│  │  • Latency P50/P95/P99: 延迟分位                                │   │
│  │  • User Satisfaction: 用户满意度                                │   │
│  │  • Completeness: 完整性                                         │   │
│  │  • Relevance: 相关性                                            │   │
│  │  • Coherence: 连贯性                                            │   │
│  │                                                                 │   │
│  │  阈值检查:                                                       │   │
│  │  • 每个指标设置threshold                                        │   │
│  │  • 自动计算passed状态                                           │   │
│  │  • 加权综合评分                                                 │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Feedback Loop (反馈闭环)                       │   │
│  │                                                                 │   │
│  │  反馈类型:                                                       │   │
│  │  • POSITIVE: 正面反馈                                           │   │
│  │  • NEGATIVE: 负面反馈                                           │   │
│  │  • NEUTRAL: 中性反馈                                            │   │
│  │  • CORRECTION: 纠正反馈                                         │   │
│  │  • SUGGESTION: 建议反馈                                         │   │
│  │                                                                 │   │
│  │  聚合分析:                                                       │   │
│  │  • 按组件/操作聚合                                              │   │
│  │  • 满意度率计算                                                 │   │
│  │  • Top问题/建议提取                                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Offline Benchmark (离线评测)                   │   │
│  │                                                                 │   │
│  │  测试用例类型:                                                   │   │
│  │  • STANDARD: 标准用例                                           │   │
│  │  • EDGE_CASE: 边缘用例                                          │   │
│  │  • REGRESSION: 回归用例                                         │   │
│  │  • PERFORMANCE: 性能用例                                        │   │
│  │  • SAFETY: 安全用例                                             │   │
│  │  • ADVERSARIAL: 对抗用例                                        │   │
│  │                                                                 │   │
│  │  评估器:                                                         │   │
│  │  • exact_match: 精确匹配                                        │   │
│  │  • contains: 包含匹配                                           │   │
│  │  • json_match: JSON匹配                                         │   │
│  │  • custom: 自定义评估器                                         │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│                                 ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Strategy Canary (策略灰度)                     │   │
│  │                                                                 │   │
│  │  灰度流程:                                                       │   │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐ │   │
│  │  │  1%流量  │ -> │  5%流量  │ -> │ 25%流量  │ -> │ 100%流量 │ │   │
│  │  │  观察期  │    │  观察期  │    │  观察期  │    │  全量    │ │   │
│  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘ │   │
│  │                                                                 │   │
│  │  自动回滚条件:                                                   │   │
│  │  • error_rate > threshold                                      │   │
│  │  • latency_p95 > threshold                                     │   │
│  │  • user_satisfaction < threshold                               │   │
│  │                                                                 │   │
│  │  指标对比:                                                       │   │
│  │  • baseline_metrics vs canary_metrics                          │   │
│  │  • 实时监控和告警                                               │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 灰度发布配置

```json
{
  "canary_config": {
    "initial_percentage": 1.0,
    "increment_percentage": 5.0,
    "increment_interval_minutes": 30,
    "max_percentage": 100.0,
    "min_sample_size": 100,
    
    "error_rate_threshold": 0.05,
    "latency_p95_threshold_ms": 5000,
    "satisfaction_threshold": 0.7,
    
    "auto_rollback": true,
    "auto_promote": true
  }
}
```

### 核心接口

```python
class QualityEvaluator:
    def evaluate(component: str, version: str, test_cases: List) -> EvaluationResult
    def compare_results(eval_id_1: str, eval_id_2: str) -> Dict
    def get_trend(component: str, metric_name: str) -> List

class FeedbackLoop:
    def submit(feedback_type: FeedbackType, component: str, rating: float) -> FeedbackEntry
    def submit_user_feedback(component: str, rating: float, comment: str) -> FeedbackEntry
    def submit_correction(component: str, expected: Any, actual: Any) -> FeedbackEntry
    def aggregate(component: str, days: int) -> FeedbackAggregation

class OfflineBenchmark:
    def create_suite(name: str, description: str) -> BenchmarkSuite
    def add_test_case(suite_id: str, name: str, input: Any, expected: Any) -> TestCase
    def run_benchmark(suite_id: str, executor: Callable) -> BenchmarkRun
    def get_regression_report(component: str, baseline_run_id: str) -> Dict

class StrategyCanary:
    def create_canary(strategy: str, baseline: str, canary: str) -> CanaryRelease
    def start_canary(canary_id: str) -> bool
    def route_request(strategy: str) -> (str, str)
    def record_metrics(strategy: str, target: str, latency: int, success: bool)
    def check_canary(canary_id: str) -> Dict
    def abort_canary(canary_id: str, reason: str) -> bool
```

### 验收标准

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    新增模块验收标准                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  多租户资源隔离:                                                         │
│  • 租户配额检查延迟 < 5ms                                               │
│  • 限流精度 > 99%                                                       │
│  • 资源隔离无泄漏                                                       │
│                                                                         │
│  多级缓存:                                                               │
│  • L1命中率 > 80%                                                       │
│  • L2命中率 > 95%                                                       │
│  • 失效广播延迟 < 100ms                                                 │
│  • 缓存一致性 > 99.9%                                                   │
│                                                                         │
│  错误模式学习:                                                           │
│  • 模式匹配准确率 > 85%                                                 │
│  • 反模式检测召回率 > 80%                                               │
│  • 学习任务处理延迟 < 10s                                               │
│                                                                         │
│  质量反馈闭环:                                                           │
│  • 评估延迟 < 30s (1000测试用例)                                        │
│  • 灰度决策延迟 < 1min                                                  │
│  • 回滚触发延迟 < 5s                                                    │
│  • 反馈聚合延迟 < 1min                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2.18 Long-Running Agent Harness（长运行代理利用框架）

### 设计思路

基于 Anthropic 长运行代理研究（Effective Harnesses for Long-Running Agents），实现跨多上下文窗口的持续工作能力。核心挑战是解决代理在离散会话中工作、每个新会话开始时没有先前记忆的问题。

**核心设计原则**：
1. **双代理架构**：初始化代理(Initializer Agent) + 编码代理(Coding Agent)
2. **增量进度**：每次会话只处理一个功能特性，确保可完成性
3. **清洁状态**：会话结束时确保代码可合并、无重大Bug、文档完整
4. **快速上下文**：通过进度文件+Git历史快速恢复工作状态
5. **自动验证**：强制端到端测试，防止过早标记完成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    长运行代理利用框架架构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Session Manager (会话管理器)                    │   │
│  │                                                                 │   │
│  │  会话类型:                                                       │   │
│  │  • INITIALIZER: 初始化会话 - 创建环境、功能列表、初始提交        │   │
│  │  • CODING: 编码会话 - 增量实现功能特性                          │   │
│  │  • TESTING: 测试会话 - 端到端验证                               │   │
│  │  • REVIEW: 审查会话 - 代码审查和质量检查                        │   │
│  │  • CLEANUP: 清理会话 - 技术债务清理                             │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                 │                                      │
│           ┌─────────────────────┼─────────────────────┐                │
│           │                     │                     │                │
│           ▼                     ▼                     ▼                │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐         │
│  │  Initializer │      │ Coding Agent │      │Context Bridge│         │
│  │    Agent     │      │              │      │              │         │
│  │  初始化代理  │      │  编码代理    │      │  上下文桥接  │         │
│  └──────┬───────┘      └──────┬───────┘      └──────┬───────┘         │
│         │                     │                     │                  │
│         └─────────────────────┼─────────────────────┘                  │
│                               │                                        │
│                               ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Progress Tracker (进度追踪器)                  │   │
│  │                                                                 │   │
│  │  追踪内容:                                                       │   │
│  │  • feature_list.json: 功能特性列表与状态                        │   │
│  │  • progress.jsonl: 进度条目流式记录                              │   │
│  │  • .checkpoints/: 检查点快照                                    │   │
│  │  • Git历史: 提交记录与代码变更                                  │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 初始化代理（Initializer Agent）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     初始化代理工作流程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  输入: 用户规格描述 (spec_prompt)                                        │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Step 1: 项目结构搭建                                             │  │
│  │                                                                  │  │
│  │  创建目录结构:                                                    │  │
│  │  project_root/                                                   │  │
│  │  ├── src/           # 源代码                                     │  │
│  │  ├── tests/         # 测试文件                                   │  │
│  │  ├── docs/          # 文档                                       │  │
│  │  ├── config/        # 配置文件                                   │  │
│  │  └── .checkpoints/  # 检查点存储                                 │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Step 2: 功能列表生成                                             │  │
│  │                                                                  │  │
│  │  基于用户规格生成原子化、可测试的功能特性:                         │  │
│  │                                                                  │  │
│  │  {                                                               │  │
│  │    "feature_id": "feat-001",                                     │  │
│  │    "category": "functional",                                     │  │
│  │    "description": "用户可以创建新对话",                          │  │
│  │    "steps": [                                                    │  │
│  │      "点击'新建对话'按钮",                                        │  │
│  │      "验证新对话被创建",                                          │  │
│  │      "确认对话出现在侧边栏"                                       │  │
│  │    ],                                                            │  │
│  │    "status": "pending",                                          │  │
│  │    "priority": "critical"                                        │  │
│  │  }                                                               │  │
│  │                                                                  │  │
│  │  关键约束: 所有功能初始状态为 pending/failing                     │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Step 3: 环境初始化脚本                                           │  │
│  │                                                                  │  │
│  │  init.sh 内容:                                                    │  │
│  │  • 安装依赖 (npm/pip)                                            │  │
│  │  • 配置环境变量                                                   │  │
│  │  • 启动开发服务器                                                 │  │
│  │  • 运行基本健康检查                                               │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Step 4: 初始提交                                                 │  │
│  │                                                                  │  │
│  │  Git操作:                                                         │  │
│  │  • git init                                                      │  │
│  │  • git add -A                                                    │  │
│  │  • git commit -m "Initial commit: Project scaffolding"           │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  输出: EnvironmentSetup                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 编码代理（Coding Agent）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      编码代理工作流程                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  会话启动流程:                                                           │
│                                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Phase 1: 获取上下文 (get_bearings)                               │  │
│  │                                                                  │  │
│  │  1. pwd - 确认工作目录                                           │  │
│  │  2. 读取 progress.jsonl - 了解最近工作                           │  │
│  │  3. 读取 feature_list.json - 获取功能状态                        │  │
│  │  4. git log --oneline -20 - 查看最近提交                         │  │
│  │  5. 检查 init.sh - 确认启动脚本存在                               │  │
│  │  6. 启动开发服务器并运行基本测试                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Phase 2: 选择下一个功能                                         │  │
│  │                                                                  │  │
│  │  选择策略:                                                        │  │
│  │  1. 优先级排序: critical > high > medium > low                   │  │
│  │  2. 依赖检查: 确保依赖项已完成                                    │  │
│  │  3. 状态过滤: 只选择 pending/failed 状态                         │  │
│  │                                                                  │  │
│  │  约束: 每次只处理一个功能                                        │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Phase 3: 增量实现                                               │  │
│  │                                                                  │  │
│  │  实现原则:                                                        │  │
│  │  • 只修改与当前功能相关的代码                                     │  │
│  │  • 保持代码清洁、可测试                                           │  │
│  │  • 不引入不相关的变更                                             │  │
│  │  • 遵循代码规范                                                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Phase 4: 端到端验证                                             │  │
│  │                                                                  │  │
│  │  验证方式:                                                        │  │
│  │  • 单元测试 (pytest/jest)                                        │  │
│  │  • 集成测试                                                       │  │
│  │  • 浏览器自动化 (Puppeteer/Selenium)                             │  │
│  │  • 手动验证步骤                                                   │  │
│  │                                                                  │  │
│  │  关键: 只有测试通过才能标记功能为 passed                          │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  Phase 5: 提交与记录                                             │  │
│  │                                                                  │  │
│  │  清理操作:                                                        │  │
│  │  • git add <changed_files>                                       │  │
│  │  • git commit -m "feat(xxx): description [tests: passed]"       │  │
│  │  • 更新 feature_list.json 状态                                   │  │
│  │  • 追加 progress.jsonl 记录                                      │  │
│  │  • 创建检查点（如果需要）                                         │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 上下文桥接（Context Bridge）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     上下文桥接机制                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  目的: 让新会话快速理解工作状态，无需重复探索                             │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    BridgedContext 结构                           │   │
│  │                                                                 │   │
│  │  source_session: 源会话ID                                       │   │
│  │  target_session: 目标会话ID                                     │   │
│  │  feature_list: 当前功能列表及状态                               │   │
│  │  recent_progress: 最近进度条目                                  │   │
│  │  last_checkpoint: 最后检查点                                    │   │
│  │  git_history: Git提交历史                                       │   │
│  │  environment_state: 环境状态分析                                │   │
│  │  recommendations: 下一步建议                                    │   │
│  │  urgent_issues: 紧急问题列表                                    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  桥接流程:                                                               │
│                                                                         │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐         │
│  │ 加载功能 │───▶│ 加载进度 │───▶│ 加载检查 │───▶│ 分析环境 │         │
│  │   列表   │    │   历史   │    │   点     │    │   状态   │         │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘         │
│                                                        │                │
│                                                        ▼                │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐         │
│  │ 生成移交 │◀───│ 识别紧急 │◀───│ 生成建议 │◀───│ 加载Git  │         │
│  │   文档   │    │   问题   │    │   列表   │    │   历史   │         │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘         │
│                                                                         │
│  移交文档 (Handoff Document):                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ # Session Handoff Document                                      │   │
│  │                                                                 │   │
│  │ ## Current State                                                │   │
│  │ - Completed Features: 15/50                                     │   │
│  │ - Pending Features: 30                                          │   │
│  │ - Failed Features: 5                                            │   │
│  │                                                                 │   │
│  │ ## Next Feature to Work On                                      │   │
│  │ - Feature ID: feat-016                                          │   │
│  │ - Priority: HIGH                                                │   │
│  │ - Description: User can send messages                           │   │
│  │                                                                 │   │
│  │ ## Active Blockers                                              │   │
│  │ - Database connection timeout                                   │   │
│  │                                                                 │   │
│  │ ## Recent Commits                                               │   │
│  │ - abc1234: feat(feat-015): Add message input                    │   │
│  │ - def5678: feat(feat-014): Implement chat UI                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 检查点与恢复

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     检查点与恢复机制                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  检查点结构 (CheckpointData):                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ {                                                               │   │
│  │   "checkpoint_id": "cp-abc123",                                 │   │
│  │   "session_id": "code-xyz789",                                  │   │
│  │   "timestamp": 1703275200,                                      │   │
│  │   "feature_states": {                                           │   │
│  │     "feat-001": "passed",                                       │   │
│  │     "feat-002": "passed",                                       │   │
│  │     "feat-003": "in_progress"                                   │   │
│  │   },                                                            │   │
│  │   "progress_summary": "Completed 2 features",                   │   │
│  │   "pending_tasks": ["feat-003", "feat-004", ...],              │   │
│  │   "files_snapshot": {                                           │   │
│  │     "feature_list.json": "a1b2c3d4",                            │   │
│  │     "progress.jsonl": "e5f6g7h8"                                │   │
│  │   },                                                            │   │
│  │   "git_status": {                                               │   │
│  │     "branch": "main",                                           │   │
│  │     "clean": true                                               │   │
│  │   },                                                            │   │
│  │   "health_metrics": {                                           │   │
│  │     "context_usage": 0.65,                                      │   │
│  │     "features_completed": 2,                                    │   │
│  │     "features_total": 50                                        │   │
│  │   },                                                            │   │
│  │   "recovery_hint": "Continue with feat-003"                     │   │
│  │ }                                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  恢复策略 (RecoveryStrategy):                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ROLLBACK: 回滚到最后提交，恢复到已知良好状态                      │   │
│  │ RESTART: 重新开始当前功能                                        │   │
│  │ SKIP:     标记当前功能为阻塞，继续下一个                         │   │
│  │ ESCALATE: 上报问题，等待人工介入                                 │   │
│  │ COMPENSATE: 执行补偿操作修复状态                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  触发条件:                                                               │
│  • 上下文窗口使用率 >= 85%                                              │
│  • 连续N次测试失败                                                      │
│  • 检测到代码处于不可用状态                                              │
│  • 会话超时                                                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 失败模式与解决方案

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    常见失败模式与解决方案                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  问题 1: 代理过早宣布项目完成                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 症状: 代理看到一些进度后认为任务已全部完成                        │   │
│  │                                                                  │   │
│  │ 解决方案:                                                         │   │
│  │  • 初始化代理创建详细的功能列表                                   │   │
│  │  • 编码代理启动时读取功能列表                                     │   │
│  │  • 强制验证所有功能状态                                           │   │
│  │  • 只在所有功能通过时才标记项目完成                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  问题 2: 代理一次性做太多事情                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 症状: 上下文在实现中途耗尽，留下半成品                            │   │
│  │                                                                  │   │
│  │ 解决方案:                                                         │   │
│  │  • 强制增量模式：每次只处理一个功能                               │   │
│  │  • 监控上下文使用率                                               │   │
│  │  • 达到阈值时创建检查点并优雅结束                                 │   │
│  │  • 下次会话从检查点恢复                                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  问题 3: 代码环境有Bug或未记录的变更                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 症状: 新会话开始时发现代码不可用                                  │   │
│  │                                                                  │   │
│  │ 解决方案:                                                         │   │
│  │  • 会话开始时运行 init.sh                                        │   │
│  │  • 执行基本端到端测试                                             │   │
│  │  • 发现问题立即修复                                               │   │
│  │  • 所有变更必须提交并记录                                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  问题 4: 功能标记为完成但实际有Bug                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 症状: 功能状态为passed但端到端不工作                              │   │
│  │                                                                  │   │
│  │ 解决方案:                                                         │   │
│  │  • 强制端到端验证                                                 │   │
│  │  • 使用浏览器自动化工具测试                                       │   │
│  │  • 只有人工验证步骤也通过才标记passed                             │   │
│  │  • 使用JSON格式存储功能列表（不易被修改）                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 核心接口

```python
class SessionManager:
    def initialize_project(spec_prompt: str) -> EnvironmentSetup
    def start_coding_session() -> SessionContext
    def get_bearings() -> Dict[str, Any]
    def select_next_feature() -> Optional[Feature]
    def implement_feature(feature: Feature) -> IncrementalProgress
    def run_incremental_cycle(max_features: int) -> List[IncrementalProgress]
    def create_checkpoint() -> CheckpointData
    def recover(strategy: RecoveryStrategy) -> bool
    def bridge_to_next_session() -> BridgedContext
    def create_handoff_document() -> str
    def end_session() -> Dict[str, Any]
    def get_project_status() -> Dict[str, Any]
    def is_project_complete() -> bool

class InitializerAgent:
    def initialize(spec_prompt: str) -> EnvironmentSetup
    def set_llm_callback(callback: Callable)
    def register_tool(name: str, handler: Callable)
    def get_features() -> List[Feature]

class CodingAgent:
    def start_session(context: SessionContext) -> SessionContext
    def get_bearings() -> Dict[str, Any]
    def select_next_feature() -> Optional[Feature]
    def implement_feature(feature: Feature) -> IncrementalProgress
    def create_checkpoint() -> CheckpointData
    def recover(strategy: RecoveryStrategy) -> bool
    def end_session() -> Dict[str, Any]

class ContextBridge:
    def bridge(source_session: str, target_session: str) -> BridgedContext
    def quick_handoff(session_id: str) -> Dict[str, Any]
    def create_handoff_document(session_id: str) -> str

class ProgressTracker:
    def record(entry: ProgressEntry) -> None
    def get_recent_entries(limit: int) -> List[ProgressEntry]
    def get_session_progress(session_id: str) -> SessionProgress
    def search_entries(filters: Dict) -> List[ProgressEntry]
    def get_active_blockers() -> List[Dict]
```

### 文件结构

```
code/
├── core/
│   └── long_running/
│       ├── __init__.py           # 模块导出
│       ├── base_types.py         # 基础类型定义
│       │   - SessionState        # 会话状态枚举
│       │   - SessionType         # 会话类型枚举
│       │   - FeatureStatus       # 功能状态枚举
│       │   - Feature             # 功能特性数据类
│       │   - ProgressEntry       # 进度条目数据类
│       │   - SessionContext      # 会话上下文数据类
│       │   - CheckpointData      # 检查点数据类
│       │   - RecoveryStrategy    # 恢复策略枚举
│       │   - EnvironmentSetup    # 环境设置数据类
│       │   - IncrementalProgress # 增量进度数据类
│       │   - BridgedContext      # 桥接上下文数据类
│       │
│       ├── initializer.py        # 初始化代理
│       │   - InitializerConfig   # 初始化配置
│       │   - InitializerAgent    # 初始化代理实现
│       │
│       ├── coding_agent.py       # 编码代理
│       │   - CodingAgentConfig   # 编码代理配置
│       │   - CodingAgent         # 编码代理实现
│       │
│       ├── progress_tracker.py   # 进度追踪器
│       │   - ProgressTrackerConfig
│       │   - ProgressTracker     # 进度追踪实现
│       │   - SessionProgress     # 会话进度统计
│       │
│       ├── context_bridge.py     # 上下文桥接
│       │   - ContextBridgeConfig
│       │   - ContextBridge       # 桥接实现
│       │
│       └── session_manager.py    # 会话管理器
│           - SessionManagerConfig
│           - SessionManager      # 统一入口
```

### 与原生方案对比增强

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    X架构增强 vs 原生方案对比                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  能力维度          │ 原生方案        │ X架构增强        │ 提升幅度      │
│  ─────────────────────────────────────────────────────────────────────  │
│  会话类型          │ 2种            │ 5种              │ +150%        │
│  恢复策略          │ 单一           │ 5种              │ +400%        │
│  检查点粒度        │ 无             │ 多维度           │ ∞            │
│  移交文档          │ 简单           │ 结构化+分析      │ +200%        │
│  上下文监控        │ 无             │ 实时             │ ∞            │
│  自动测试          │ 可选           │ 强制             │ 质量保障     │
│  功能依赖          │ 无             │ DAG依赖图        │ ∞            │
│  优先级调度        │ 简单           │ 多维度排序       │ +100%        │
│  错误归因          │ 无             │ 自动分析         │ ∞            │
│  多会话协调        │ 无             │ SessionManager   │ ∞            │
│  Git集成           │ 基础           │ 深度集成         │ +100%        │
│  浏览器测试        │ Puppeteer      │ 多框架支持       │ +50%         │
│  配置热更新        │ 无             │ 支持             │ ∞            │
│  多租户隔离        │ 无             │ 完整支持         │ ∞            │
│  成本追踪          │ 无             │ 完整支持         │ ∞            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 验收标准

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    长运行代理利用框架验收标准                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  初始化性能:                                                             │
│  • 功能列表生成延迟 < 30s (100个功能)                                    │
│  • 环境初始化延迟 < 10s                                                  │
│  • 初始提交延迟 < 5s                                                     │
│                                                                         │
│  编码代理性能:                                                           │
│  • 上下文获取延迟 < 2s                                                   │
│  • 功能选择延迟 < 100ms                                                  │
│  • 检查点创建延迟 < 1s                                                   │
│  • 会话结束延迟 < 500ms                                                  │
│                                                                         │
│  进度追踪性能:                                                           │
│  • 进度记录延迟 < 10ms                                                   │
│  • 进度查询延迟 < 50ms (10000条记录)                                     │
│  • 搜索延迟 < 100ms                                                      │
│                                                                         │
│  上下文桥接性能:                                                         │
│  • 桥接创建延迟 < 500ms                                                  │
│  • 移交文档生成延迟 < 1s                                                 │
│                                                                         │
│  可靠性:                                                                 │
│  • 会话恢复成功率 > 99%                                                  │
│  • 检查点完整性 > 99.9%                                                  │
│  • 数据一致性 > 99.99%                                                   │
│                                                                         │
│  功能完整性:                                                             │
│  • 支持5种会话类型                                                       │
│  • 支持5种恢复策略                                                       │
│  • 支持功能依赖DAG                                                       │
│  • 支持多级优先级                                                        │
│  • 支持自动/手动测试                                                     │
│  • 支持结构化移交文档                                                    │
│  • 支持上下文使用监控                                                    │
│  • 支持Git深度集成                                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**落地代码**

- core/long_running/base_types.py      → 基础类型定义
- core/long_running/initializer.py     → 初始化代理
- core/long_running/coding_agent.py    → 编码代理
- core/long_running/progress_tracker.py → 进度追踪器
- core/long_running/context_bridge.py  → 上下文桥接
- core/long_running/session_manager.py → 会话管理器
- core/long_running/__init__.py        → 模块导出

---
