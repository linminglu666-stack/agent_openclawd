# OpenClaw-X 完整架构整合文档

## 文档说明

本文档整合了事无巨细的设计思路、流程图、实现细节、模块间数据接口与通信协议。

---


# 第十二部分：分布式追踪深度设计

## 12.1 设计思路

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    分布式追踪设计目标                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  核心理念:                                                              │
│  • 全链路可追溯 - trace_id贯穿所有组件                                  │
│  • 上下文传播 - 跨进程/跨服务传递追踪信息                               │
│  • 采样策略 - 智能采样平衡性能与完整性                                  │
│  • 可视化分析 - 直观展示调用链与依赖关系                                │
│                                                                         │
│  追踪粒度:                                                              │
│  • L1: 服务级追踪 - 服务间调用关系                                      │
│  • L2: Agent级追踪 - Agent任务执行链                                    │
│  • L3: 推理级追踪 - 推理步骤与决策点                                    │
│  • L4: Token级追踪 - LLM调用详情（可选）                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 12.2 追踪上下文结构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    TraceContext 结构                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  @dataclass                                                             │
│  class TraceContext:                                                    │
│      trace_id: str              # 全局唯一追踪ID                        │
│      span_id: str               # 当前Span ID                          │
│      parent_span_id: str        # 父Span ID                            │
│      baggage: Dict[str, str]    # 跨进程传递的元数据                    │
│      sampled: bool              # 是否采样                              │
│      flags: int                 # 追踪标志位                            │
│                                                                         │
│  Baggage标准字段:                                                       │
│  • user_id      - 用户ID                                               │
│  • tenant_id    - 租户ID                                               │
│  • session_id   - 会话ID                                               │
│  • agent_id     - Agent ID                                             │
│  • task_type    - 任务类型                                             │
│  • priority     - 优先级                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 12.3 Span结构设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Span 结构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  @dataclass                                                             │
│  class Span:                                                            │
│      trace_id: str                                                      │
│      span_id: str                                                       │
│      parent_span_id: Optional[str]                                      │
│      operation_name: str                                                │
│      start_time: int            # 微秒时间戳                            │
│      duration: int              # 微秒持续时间                          │
│      span_kind: SpanKind        # CLIENT/SERVER/PRODUCER/CONSUMER      │
│      status: SpanStatus         # OK/ERROR                              │
│      attributes: Dict[str, Any] # 结构化属性                            │
│      events: List[SpanEvent]    # 时间点事件                            │
│      links: List[SpanLink]      # 关联Span                              │
│                                                                         │
│  SpanKind枚举:                                                          │
│  • CLIENT     - 客户端调用                                              │
│  • SERVER     - 服务端处理                                              │
│  • PRODUCER   - 消息生产者                                              │
│  • CONSUMER   - 消息消费者                                              │
│  • INTERNAL   - 内部操作                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 12.4 采样策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         采样策略矩阵                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 策略名称        │ 采样率 │ 适用场景                  │ 优先级  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ AlwaysOn        │ 100%   │ 调试/开发环境             │ 最高    │   │
│  │ AlwaysOff       │ 0%     │ 性能压测                  │ 最高    │   │
│  │ Probabilistic   │ 可配置 │ 生产环境常规              │ 中      │   │
│  │ RateLimiting    │ N/s    │ 高流量场景                │ 中      │   │
│  │ Adaptive        │ 动态   │ 自动调节                  │ 低      │   │
│  │ ErrorBased      │ 错误全采│ 故障排查                  │ 高      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  智能采样规则:                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│  • 错误请求: 100%采样                                                   │
│  • 慢请求 (>P99): 100%采样                                              │
│  • 高优先级任务: 100%采样                                               │
│  • 新发布功能: 提高采样率                                               │
│  • 正常请求: 按概率采样                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 12.5 上下文传播机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    上下文传播流程                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  HTTP传播:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Request Headers:                                                 │   │
│  │   traceparent: 00-{trace_id}-{span_id}-{flags}                  │   │
│  │   tracestate: vendor1=value1,vendor2=value2                     │   │
│  │   baggage: key1=value1,key2=value2                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  消息队列传播:                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Message Headers:                                                 │   │
│  │   {                                                              │   │
│  │     "trace_id": "abc123",                                        │   │
│  │     "span_id": "def456",                                         │   │
│  │     "parent_span_id": "ghi789",                                  │   │
│  │     "baggage": {...}                                             │   │
│  │   }                                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Agent间传播:                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Task Schema:                                                     │   │
│  │   {                                                              │   │
│  │     "task_id": "...",                                            │   │
│  │     "trace_context": {                                           │   │
│  │       "trace_id": "...",                                         │   │
│  │       "parent_span_id": "...",                                   │   │
│  │       "baggage": {...}                                           │   │
│  │     }                                                            │   │
│  │   }                                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 12.6 推理链追踪

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    推理链追踪示例                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Span树结构:                                                            │
│                                                                         │
│  task.execute (span_001)                                                │
│  ├── strategy_router.select (span_002)                                  │
│  │   └── problem_classifier.classify (span_003)                         │
│  ├── reasoning.cot (span_004)                                           │
│  │   ├── llm.call (span_005)                                            │
│  │   │   └── token_usage: {input: 500, output: 200}                     │
│  │   ├── step_1.think (span_006)                                        │
│  │   ├── step_2.think (span_007)                                        │
│  │   └── step_3.conclude (span_008)                                     │
│  ├── truth_gate.validate (span_009)                                     │
│  │   ├── consistency_check (span_010)                                    │
│  │   └── fact_verification (span_011)                                   │
│  └── memory.store (span_012)                                            │
│      └── evidence_chain.append (span_013)                               │
│                                                                         │
│  关键属性:                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  • reasoning.strategy: "cot"                                            │
│  • reasoning.steps: 3                                                   │
│  • reasoning.confidence: 0.85                                           │
│  • llm.model: "gpt-4"                                                   │
│  • llm.tokens_input: 500                                                │
│  • llm.tokens_output: 200                                               │
│  • llm.latency_ms: 1200                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 12.7 追踪存储与查询

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    追踪存储架构                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  存储选型:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 存储类型   │ 适用场景           │ 保留周期   │ 查询能力        │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ Jaeger     │ 开发/测试          │ 7天        │ 基础查询        │   │
│  │ Tempo      │ 生产环境          │ 30天       │ 高效查询        │   │
│  │ ClickHouse │ 大规模分析        │ 90天       │ 复杂分析        │   │
│  │ ES         │ 全文检索          │ 30天       │ 全文搜索        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  查询接口:                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  • GET /traces/{trace_id} - 获取完整追踪链                             │
│  • GET /traces?service=X&duration>Y - 条件查询                         │
│  • GET /traces/{trace_id}/waterfall - 瀑布图数据                       │
│  • GET /dependencies - 服务依赖图                                       │
│  • GET /metrics/latency?group_by=service - 延迟统计                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 12.8 服务实现

```python
class TracingService:
    def __init__(self, config: TracingConfig):
        self._exporter: SpanExporter
        self._sampler: Sampler
        self._propagator: Propagator
    
    def start_span(
        self,
        operation_name: str,
        kind: SpanKind,
        parent: Optional[Span] = None,
        attributes: Optional[Dict] = None,
    ) -> Span:
        ...
    
    def inject_context(self, carrier: Dict, context: TraceContext) -> None:
        ...
    
    def extract_context(self, carrier: Dict) -> TraceContext:
        ...
    
    def record_event(
        self,
        span: Span,
        name: str,
        attributes: Optional[Dict] = None,
    ) -> None:
        ...
    
    def set_span_status(self, span: Span, status: SpanStatus, description: str = "") -> None:
        ...
```

## 12.9 文件结构

```
code/
├── core/
│   └── tracing/
│       ├── __init__.py
│       ├── context.py          # TraceContext定义
│       ├── span.py             # Span结构
│       ├── sampler.py          # 采样策略
│       ├── propagator.py       # 上下文传播
│       ├── exporter.py         # 导出器接口
│       └── service.py          # 追踪服务
```

## 12.10 验收标准

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    分布式追踪验收标准                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  追踪完整性:                                                            │
│  • 所有服务入口有Span覆盖                                               │
│  • 跨服务调用有上下文传播                                               │
│  • 错误请求100%追踪                                                     │
│                                                                         │
│  性能影响:                                                              │
│  • 追踪开销 < 1% CPU                                                    │
│  • 追踪延迟 < 1ms                                                       │
│  • 内存占用 < 50MB/进程                                                 │
│                                                                         │
│  可观测性:                                                              │
│  • 追踪数据实时可见                                                     │
│  • 瀑布图正确展示                                                       │
│  • 依赖图准确生成                                                       │
│                                                                         │
│  采样效率:                                                              │
│  • 错误请求采样率 100%                                                  │
│  • 正常请求采样率可配置                                                 │
│  • 采样决策延迟 < 1μs                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---
