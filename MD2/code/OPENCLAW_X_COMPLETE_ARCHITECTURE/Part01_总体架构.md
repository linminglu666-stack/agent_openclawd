# OpenClaw-X 完整架构整合文档

## 文档说明

本文档整合了事无巨细的设计思路、流程图、实现细节、模块间数据接口与通信协议。

---


# 第一部分：总体架构

## 1.1 设计理念

### 核心目标

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        OpenClaw-X 设计理念                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 保留内核：保留 OpenClaw 最小可用内核，通过适配层暴露稳定 API          │
│                                                                         │
│  2. 替换上层：全面替换上层机制为自研模块，形成可自主演进的 OpenClaw-X     │
│                                                                         │
│  3. 推理增强：通过 CoT/ToT/Reflexion 等策略提升大模型推理深度            │
│                                                                         │
│  4. 多Agent协作：中央机统一分发，多Agent并发协作与自主成长                │
│                                                                         │
│  5. 本能化自愈：不依赖人工判断即可自恢复、自纠错、自告警                  │
│                                                                         │
│  6. 全链追溯：trace_id 贯穿全链路，证据链完整可追溯                      │
│                                                                         │
│  7. 多模型并行：支持多LLM同时在线，智能路由+负载均衡+故障转移            │
│                                                                         │
│  8. 成本优化：根据任务复杂度匹配模型，动态感知定价                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 与原生OpenClaw对比

| 能力维度 | 原生OpenClaw | OpenClaw-X | 提升幅度 |
|---------|-------------|------------|---------|
| 推理深度 | 单次LLM调用 | CoT/ToT/Reflexion多策略 | +200% |
| 答案准确性 | 依赖模型能力 | Self-Consistency+TruthGate | +30% |
| 故障恢复 | 手动介入 | 自动检测+分级恢复 | +500% |
| 自主学习 | 无 | 空闲学习+技能沉淀 | ∞ |
| 任务路由 | 简单轮询 | 技能匹配+负载均衡+风险评估 | +150% |
| 并发能力 | 单Worker | Agent池化+资源隔离 | +400% |
| 可追溯性 | 基础日志 | 证据链+决策链+快照 | +300% |
| 自愈能力 | 无 | 本能化自修复 | ∞ |
| 多模型支持 | 单模型绑定 | 多模型并行+智能路由+故障转移 | ∞ |
| 成本优化 | 无 | 复杂度匹配+动态定价感知 | -50% |

## 1.2 分层架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              OpenClaw-X 完整架构                                      │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                      Layer 6: 用户交互层                                      │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                    │   │
│  │  │  Web Admin    │  │  CLI Client   │  │  API Gateway  │                    │   │
│  │  │  Backoffice   │  │               │  │  (BFF)        │                    │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘                    │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                      Layer 5: 中央机层 (Central Brain)                        │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐            │   │
│  │  │Task Router │  │Risk Adjudic│  │Exp Broadcast│ │Resource Sch│            │   │
│  │  │任务路由    │  │风险裁决    │  │经验广播    │  │资源调度    │            │   │
│  │  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘            │   │
│  └────────┼───────────────┼───────────────┼───────────────┼───────────────────┘   │
│           │               │               │               │                        │
│           └───────────────┴───────┬───────┴───────────────┘                        │
│                                   │                                                 │
│                      ┌────────────┴────────────┐                                    │
│                      │   Layer 4: 消息总线      │                                    │
│                      │   Message Bus           │                                    │
│                      │   (Pub/Sub + EventStream)│                                    │
│                      └────────────┬────────────┘                                    │
│                                   │                                                 │
│           ┌───────────────────────┼───────────────────────┐                         │
│           │                       │                       │                         │
│           ▼                       ▼                       ▼                         │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐                   │
│  │  Layer 3:       │   │  Layer 3:       │   │  Layer 3:       │                   │
│  │  Agent Pool     │   │  Memory Hub     │   │  Growth Loop    │                   │
│  │                 │   │                 │   │                 │                   │
│  │  ┌───────────┐  │   │  EventStore     │   │ Idle Detector   │                   │
│  │  │  Agent-1  │  │   │  StateDB        │   │ Learner         │                   │
│  │  │  Agent-2  │  │   │  Evidence Chain │   │ Skill Registry  │                   │
│  │  │  ...      │  │   └─────────────────┘   └─────────────────┘                   │
│  │  └───────────┘  │                                                          │   │
│  └────────┬────────┘                                                          │   │
│           │                                                                    │   │
│           ▼                                                                    │   │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │   │
│  │                Layer 2: 推理增强层 (Reasoning Enhancement)               │    │   │
│  │                                                                         │    │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │    │   │
│  │  │StrategyRouter│  │ CoTInjector  │  │ScratchpadMgr │                  │    │   │
│  │  │策略路由      │  │思维链注入    │  │工作记忆      │                  │    │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                  │    │   │
│  │         │                 │                 │                           │    │   │
│  │         ▼                 ▼                 ▼                           │    │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │    │   │
│  │  │                    执行引擎 (Execution Engines)                  │   │    │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │   │    │   │
│  │  │  │SelfCons │ │   ToT   │ │Reflexion│ │CodeInterp│ │TruthGate│  │   │    │   │
│  │  │  │采样投票 │ │思维树   │ │反思迭代 │ │代码沙箱 │ │真值门   │  │   │    │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘  │   │    │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │    │   │
│  └─────────────────────────────────────────────────────────────────────────┘    │   │
│                                                                                   │   │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │   │
│  │                     Layer 1: 基础设施层 (Foundation)                     │    │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │    │   │
│  │  │ Kernel  │ │Scheduler│ │Orchestr.│ │  Auth   │ │ Config  │           │    │   │
│  │  │内核     │ │调度器   │ │编排器   │ │JWT/RBAC │ │配置回滚 │           │    │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘           │    │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │    │   │
│  │  │RiskScor │ │EvalGate │ │Memory   │ │Skills   │ │Observ.  │           │    │   │
│  │  │风险评分 │ │评估门   │ │记忆     │ │技能生态 │ │可观测   │           │    │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘           │    │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │    │   │
│  │  │ModelHub │ │ Router  │ │LoadBal. │ │Failover │ │MultiTena│           │    │   │
│  │  │多模型   │ │智能路由 │ │负载均衡 │ │故障转移 │ │多租户   │           │    │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘           │    │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │    │   │
│  │  │Caching  │ │ErrorLrn │ │Quality  │ │Feedback │ │Canary   │           │    │   │
│  │  │多级缓存 │ │错误学习 │ │质量评估 │ │反馈闭环 │ │灰度发布 │           │    │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘           │    │   │
│  └─────────────────────────────────────────────────────────────────────────┘    │   │
│                                                                                   │   │
└───────────────────────────────────────────────────────────────────────────────────┘
```

## 1.3 系统服务架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           系统服务架构                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────┐     ┌─────────────────────┐                          │
│  │ openclawd-scheduler │     │openclawd-orchestrator│                          │
│  │ .service            │     │.service              │                          │
│  │                     │     │                      │                          │
│  │ • schedule-only引擎 │     │ • DAG执行器          │                          │
│  │ • policy_json计算   │     │ • 审批闭环           │                          │
│  │ • next_fire_at      │     │ • 断点续跑           │                          │
│  └──────────┬──────────┘     └──────────┬───────────┘                          │
│             │                           │                                       │
│             └───────────┬───────────────┘                                       │
│                         │                                                       │
│                         ▼                                                       │
│  ┌─────────────────────┐     ┌─────────────────────┐                          │
│  │ openclawd-runner    │     │openclawd-memory-    │                          │
│  │ .service            │     │indexer.service      │                          │
│  │                     │     │                      │                          │
│  │ • 租约管理          │     │ • 记忆索引          │                          │
│  │ • 幂等处理          │     │ • 知识治理          │                          │
│  │ • 队列执行          │     │ • 批量管理          │                          │
│  └──────────┬──────────┘     └──────────┬───────────┘                          │
│             │                           │                                       │
│             └───────────┬───────────────┘                                       │
│                         │                                                       │
│                         ▼                                                       │
│  ┌─────────────────────┐     ┌─────────────────────┐                          │
│  │ openclawd-eval      │     │ openclawd-bff       │                          │
│  │ .service + timer    │     │ .service            │                          │
│  │                     │     │                      │                          │
│  │ • 离线评估          │     │ • API网关           │                          │
│  │ • 阈值检查          │     │ • JWT验证           │                          │
│  │ • 报告生成          │     │ • RBAC检查          │                          │
│  └─────────────────────┘     └─────────────────────┘                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---
