# OpenClaw-X 完整架构整合文档

## 文档说明

本文档整合了事无巨细的设计思路、流程图、实现细节、模块间数据接口与通信协议。

---


# 第十一部分：自监督质量评估闭环

## 11.1 设计思路

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    自监督质量评估目标                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  核心理念:                                                              │
│  • 无需人工标注，系统自动评估输出质量                                    │
│  • 通过多维度信号交叉验证，提升评估可靠性                                │
│  • 闭环反馈驱动持续改进                                                  │
│                                                                         │
│  评估维度:                                                              │
│  • 内部一致性   - 多次推理结果是否一致                                  │
│  • 外部一致性   - 与已知事实/规则是否冲突                               │
│  • 置信度校准   - 模型置信度与实际准确率是否匹配                        │
│  • 结构完整性   - 输出格式/结构是否完整                                 │
│  • 语义合理性   - 输出内容是否语义通顺                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 11.2 评估架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    自监督评估架构                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    输入层                                        │   │
│  │  任务输入 / 推理输出 / 中间状态 / 上下文信息                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    评估器层                                      │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐   │   │
│  │  │一致性检查 │  │置信度评估 │  │结构验证   │  │语义分析   │   │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    聚合层                                        │   │
│  │  多维度评分聚合 / 风险等级判定 / 置信区间计算                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    决策层                                        │   │
│  │  通过/警告/拒绝 / 触发重试 / 人工审核                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    反馈层                                        │   │
│  │  样本沉淀 / 模型校准 / 阈值调整 / 规则更新                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 11.3 核心评估器

### 11.3.1 一致性检查器

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    一致性检查器                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  自一致性评估 (Self-Consistency):                                       │
│  ─────────────────────────────────────────────────────────────────────  │
│  1. 对同一问题进行N次采样 (N=5~10)                                      │
│  2. 计算答案分布和一致性分数                                            │
│  3. 高一致性 → 高置信度                                                 │
│                                                                         │
│  交叉验证评估:                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│  1. 使用不同策略独立推理 (CoT/ToT/Reflexion)                            │
│  2. 比较各策略输出                                                      │
│  3. 结果一致 → 高置信度                                                 │
│                                                                         │
│  内部逻辑一致性:                                                        │
│  ─────────────────────────────────────────────────────────────────────  │
│  1. 检查推理步骤之间的逻辑连贯性                                        │
│  2. 识别自相矛盾的陈述                                                  │
│  3. 验证前提-结论关系                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

```python
@dataclass
class ConsistencyScore:
    self_consistency: float      # 自一致性分数
    cross_validation: float      # 交叉验证分数
    internal_logic: float        # 内部逻辑一致性
    
    overall: float               # 综合一致性分数
    confidence: float            # 评估置信度
    
    details: Dict[str, Any]      # 详细信息

class ConsistencyChecker:
    async def check(
        self,
        query: str,
        outputs: List[str],
        reasoning_traces: List[List[str]],
    ) -> ConsistencyScore:
        ...
```

### 11.3.2 置信度校准器

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    置信度校准器                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  目标: 让模型输出的置信度与实际准确率匹配                                │
│                                                                         │
│  校准方法:                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  • 温度缩放 (Temperature Scaling)                                       │
│  • 等渗回归 (Isotonic Regression)                                       │
│  • Platt Scaling                                                        │
│  • 分箱校准 (Binning Calibration)                                       │
│                                                                         │
│  评估指标:                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  • ECE (Expected Calibration Error)                                     │
│  • MCE (Maximum Calibration Error)                                      │
│  • Brier Score                                                          │
│                                                                         │
│  校准流程:                                                              │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐         │
│  │ 收集样本 │ ─→ │ 计算偏差 │ ─→ │ 训练校准 │ ─→ │ 应用校准 │         │
│  │ 预测+实际│    │ ECE/MCE  │    │ 模型     │    │ 到新预测 │         │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

```python
@dataclass
class CalibrationResult:
    original_confidence: float
    calibrated_confidence: float
    calibration_method: str
    
    ece: float                   # Expected Calibration Error
    mce: float                   # Maximum Calibration Error
    
    bin_statistics: List[BinStat]

class ConfidenceCalibrator:
    async def calibrate(
        self,
        predictions: List[PredictionWithConfidence],
        ground_truth: Optional[List[bool]] = None,
    ) -> CalibrationResult:
        ...
    
    async def update_calibration_model(
        self,
        new_samples: List[CalibrationSample],
    ) -> bool:
        ...
```

### 11.3.3 结构验证器

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    结构验证器                                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  验证类型:                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  • JSON Schema验证   - 输出是否符合预期Schema                           │
│  • 字段完整性检查    - 必填字段是否齐全                                 │
│  • 类型一致性检查    - 字段类型是否正确                                 │
│  • 值域约束检查      - 数值/枚举值是否在有效范围内                      │
│                                                                         │
│  验证规则示例:                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  {                                                              │   │
│  │    "type": "object",                                            │   │
│  │    "required": ["answer", "confidence", "reasoning"],           │   │
│  │    "properties": {                                              │   │
│  │      "answer": {"type": "string", "minLength": 1},              │   │
│  │      "confidence": {"type": "number", "minimum": 0, "maximum": 1},│  │
│  │      "reasoning": {"type": "array", "minItems": 1}              │   │
│  │    }                                                            │   │
│  │  }                                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

```python
@dataclass
class ValidationResult:
    is_valid: bool
    errors: List[ValidationError]
    warnings: List[ValidationWarning]
    
    schema_compliance: float     # Schema符合度
    field_coverage: float        # 字段覆盖率

class StructureValidator:
    def __init__(self, schema_registry: SchemaRegistry):
        self._registry = schema_registry
    
    async def validate(
        self,
        output: Any,
        schema_name: str,
    ) -> ValidationResult:
        ...
```

### 11.3.4 语义分析器

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    语义分析器                                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  分析维度:                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  • 语义连贯性    - 句子之间是否语义连贯                                 │
│  • 逻辑合理性    - 推理步骤是否逻辑合理                                 │
│  • 事实一致性    - 陈述的事实是否与知识库一致                           │
│  • 歧义检测      - 是否存在歧义表达                                     │
│                                                                         │
│  实现方法:                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  • NLI模型判断句子间逻辑关系                                            │
│  • 知识图谱查询验证事实                                                 │
│  • 困惑度评估语义流畅度                                                 │
│  • 多模型交叉验证                                                       │
│                                                                         │
│  输出:                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  SemanticScore:                                                  │   │
│  │    coherence: 0.85      # 语义连贯性                             │   │
│  │    logic: 0.92          # 逻辑合理性                             │   │
│  │    factuality: 0.78     # 事实一致性                             │   │
│  │    ambiguity: 0.05      # 歧义程度 (越低越好)                    │   │
│  │    overall: 0.85        # 综合语义分数                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 11.4 质量评分聚合

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    质量评分聚合                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  聚合公式:                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  Q = Σ(w_i × s_i) / Σw_i                                                │
│                                                                         │
│  其中:                                                                  │
│  • Q: 综合质量分数                                                      │
│  • w_i: 第i个维度的权重                                                 │
│  • s_i: 第i个维度的分数                                                 │
│                                                                         │
│  默认权重配置:                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  维度              权重      说明                                │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  一致性            0.30      核心质量指标                        │   │
│  │  置信度校准        0.20      可靠性指标                          │   │
│  │  结构完整性        0.15      格式指标                            │   │
│  │  语义合理性        0.20      内容指标                            │   │
│  │  外部验证          0.15      事实指标                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  风险等级判定:                                                          │
│  • Q ≥ 0.85  → 低风险 (通过)                                           │
│  • 0.70 ≤ Q < 0.85  → 中风险 (警告)                                    │
│  • Q < 0.70  → 高风险 (拒绝/人工审核)                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

```python
@dataclass
class QualityScore:
    overall: float
    
    consistency: float
    calibration: float
    structure: float
    semantics: float
    external_validation: float
    
    risk_level: Literal["low", "medium", "high"]
    confidence_interval: Tuple[float, float]
    
    breakdown: Dict[str, float]

class QualityAggregator:
    def __init__(self, weights: Optional[Dict[str, float]] = None):
        self._weights = weights or {
            "consistency": 0.30,
            "calibration": 0.20,
            "structure": 0.15,
            "semantics": 0.20,
            "external_validation": 0.15,
        }
    
    def aggregate(
        self,
        scores: Dict[str, float],
    ) -> QualityScore:
        ...
```

## 11.5 反馈闭环机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    反馈闭环机制                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  反馈来源:                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  • 自动反馈    - 系统自动生成的评估结果                                 │
│  • 行为反馈    - 用户行为信号 (接受/拒绝/修改)                          │
│  • 显式反馈    - 用户主动标注 (正确/错误/部分正确)                      │
│  • 环境反馈    - 任务执行结果 (成功/失败)                               │
│                                                                         │
│  反馈处理流程:                                                          │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐         │
│  │ 收集反馈 │ ─→ │ 分类存储 │ ─→ │ 分析统计 │ ─→ │ 触发改进 │         │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘         │
│       │                                                │               │
│       │    ┌──────────┐    ┌──────────┐               │               │
│       └────│ 样本沉淀 │ ─→ │ 模型更新 │ ──────────────┘               │
│            └──────────┘    └──────────┘                               │
│                                                                         │
│  改进动作:                                                              │
│  • 阈值调整    - 根据反馈调整评估阈值                                   │
│  • 规则更新    - 更新验证规则/Schema                                   │
│  • 模型校准    - 重新校准置信度模型                                     │
│  • 样本沉淀    - 高质量样本加入训练集                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 反馈数据结构

```python
@dataclass
class Feedback:
    feedback_id: str
    trace_id: str
    
    source: Literal["auto", "behavior", "explicit", "environment"]
    type: Literal["positive", "negative", "neutral"]
    
    quality_score_at_feedback: QualityScore
    actual_outcome: Optional[str]
    
    user_action: Optional[str]
    user_annotation: Optional[str]
    
    timestamp: int
    metadata: Dict[str, Any]

@dataclass
class FeedbackAnalysis:
    time_range: Tuple[int, int]
    total_feedback: int
    
    positive_rate: float
    negative_rate: float
    
    score_accuracy: float         # 评估分数与实际结果的相关性
    
    improvement_suggestions: List[str]
```

## 11.6 自监督学习循环

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    自监督学习循环                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  学习目标:                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│  • 提升评估器准确性                                                     │
│  • 优化阈值配置                                                         │
│  • 发现新的质量模式                                                     │
│  • 适应数据分布变化                                                     │
│                                                                         │
│  学习流程:                                                              │
│                                                                         │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │                                                             │    │
│     │   ┌─────────┐    ┌─────────┐    ┌─────────┐               │    │
│     │   │ 样本收集 │ ─→ │ 标签推断 │ ─→ │ 模型训练 │               │    │
│     │   └─────────┘    └─────────┘    └─────────┘               │    │
│     │        ↑              │              │                     │    │
│     │        │              ↓              ↓                     │    │
│     │   ┌─────────┐    ┌─────────┐    ┌─────────┐               │    │
│     │   │ 部署验证 │ ←─ │ 模型评估 │ ←─ │ 超参优化 │               │    │
│     │   └─────────┘    └─────────┘    └─────────┘               │    │
│     │        │                                                   │    │
│     │        └──────────────────────────────────────────────────┘    │
│     │                         持续循环                               │    │
│     └─────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  标签推断策略:                                                          │
│  • 高一致性样本 → 正样本                                                │
│  • 低一致性+行为拒绝 → 负样本                                           │
│  • 多信号交叉验证 → 伪标签                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 11.7 服务实现

### 服务接口

```python
class SelfSupervisedQualityService:
    def __init__(self, config: QualityServiceConfig):
        self._consistency_checker: ConsistencyChecker
        self._calibrator: ConfidenceCalibrator
        self._structure_validator: StructureValidator
        self._semantic_analyzer: SemanticAnalyzer
        self._aggregator: QualityAggregator
        self._feedback_processor: FeedbackProcessor
        self._learning_loop: SelfSupervisedLearningLoop
    
    async def evaluate(
        self,
        task: Task,
        output: Any,
        context: EvaluationContext,
    ) -> QualityAssessment:
        ...
    
    async def submit_feedback(
        self,
        feedback: Feedback,
    ) -> bool:
        ...
    
    async def get_quality_report(
        self,
        time_range: Tuple[int, int],
    ) -> QualityReport:
        ...
    
    async def trigger_learning(
        self,
        scope: Literal["calibration", "thresholds", "all"],
    ) -> LearningResult:
        ...
```

### 文件结构

```
code/
├── core/
│   └── quality/
│       ├── __init__.py
│       ├── service.py           # 质量评估服务
│       ├── consistency.py       # 一致性检查器
│       ├── calibration.py       # 置信度校准器
│       ├── structure.py         # 结构验证器
│       ├── semantics.py         # 语义分析器
│       ├── aggregator.py        # 评分聚合器
│       ├── feedback.py          # 反馈处理器
│       └── learning_loop.py     # 自监督学习循环
```

## 11.8 验收标准

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    自监督质量评估验收标准                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  评估准确性:                                                            │
│  • 质量分数与实际结果相关性 ≥ 0.85                                      │
│  • 高风险样本拒绝准确率 ≥ 90%                                           │
│  • 低风险样本通过准确率 ≥ 95%                                           │
│                                                                         │
│  置信度校准:                                                            │
│  • ECE (Expected Calibration Error) < 0.05                             │
│  • 校准后置信度与准确率偏差 < 5%                                        │
│                                                                         │
│  一致性检测:                                                            │
│  • 自一致性检测召回率 ≥ 95%                                             │
│  • 交叉验证一致性检测延迟 < 2秒                                         │
│                                                                         │
│  反馈闭环:                                                              │
│  • 反馈处理延迟 < 100ms                                                 │
│  • 学习循环周期 ≤ 24小时                                                │
│  • 模型更新后性能提升 ≥ 2%                                              │
│                                                                         │
│  系统可靠性:                                                            │
│  • 评估服务可用性 ≥ 99.9%                                               │
│  • 评估延迟P99 < 500ms                                                  │
│  • 支持并发评估 ≥ 100 QPS                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---
