Plan30 核心-指令型：记忆城堡机制（Memory Castle）

1. 背景与目标
- 目标：以“记忆城堡”替代单一知识库思路，形成多层结构化记忆系统。
- 价值：更强的关联索引、快速检索、跨任务迁移与冲突治理。

2. 城堡分层模型
- L0 宪法塔（Constitution Tower）：不可违背原则、硬约束。
- L1 决策殿（Decision Hall）：关键决策与版本。
- L2 证据库（Evidence Vault）：来源、引用、日志、快照。
- L3 经验坊（Practice Workshop）：任务模板、策略、失败案例。
- L4 情境庭（Context Garden）：会话上下文与短期热点记忆。
- L5 归档地窖（Archive Cellar）：冷数据与历史封存。

3. 记忆单元模型
- `MemoryAtom`: id/type/content/scope/version/confidence/source/tags/links
- `MemoryLink`: relation(strong|weak|conflict|derive|temporal)
- `MemoryCluster`: 主题簇与冲突簇

4. 索引与检索
- 三路召回：关键词 + 语义向量 + 图谱路径。
- 预算装载：优先 L0/L1，再装 L2/L3，最后 L4。
- 冲突优先：若命中冲突簇先输出裁决需求。

5. 写入与演化流程
1) ingest：对话/执行结果转 `MemoryAtom`
2) normalize：同义归一、去重、提取关系
3) classify：路由到城堡分层
4) link：生成关联边
5) snapshot：形成可回滚版本
6) review：冲突检测与晋升规则

6. 晋升与衰减策略
- 自动晋升：同义规则命中 >= 3 次，晋升候选原则。
- 置信提升：被证据重复支持则 confidence 上升。
- 衰减：长期未命中热点记忆降权至冷层。

7. 持久化设计
- 真相源：`memory_castle/events/*.jsonl`。
- 状态库：`memory_atoms/memory_links/memory_clusters`（SQLite）。
- 图谱库：`kg_nodes/kg_edges`。
- 快照：`memory_snapshots/vYYYYMMDD-NN`。

8. 恢复与一致性
- 启动：加载最新 snapshot + 回放事件。
- 索引损坏：从 snapshot+events 全量重建。
- 冲突恢复：保留多版本并要求裁决。

9. 与现有机制集成
- 对接 Plan2：替换原 memory store 为 Memory Castle。
- 对接 Plan19：每次 run 完成自动写入经验坊。
- 对接 Plan21：联网证据进入证据库并挂链。
- 对接 Plan26：自监督输出写入质量簇。

10. 性能与能耗
- 热层内存化缓存 + 冷层磁盘检索。
- 分层 TTL 与索引压缩。
- 大查询拆批执行，避免一次性加载。

11. 验收
- 检索延迟下降，召回质量提升。
- 冲突发现更早，决策一致性提升。
- 重启恢复后记忆完整性可验证。
