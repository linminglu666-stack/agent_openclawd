整体思路文档（最终版）

目标
用一套系统服务级别的“记忆 + 检索 + 上下文硬控”**模块，组合工作流来模拟不同厂商模型优势：

类 Claude：更强的“结论化/结构化上下文”

类 Kimi：更强的“长对话持续性 + 低污染记忆”

类 Gemini：更大的“可用上下文窗口”——但你要求**只取其 50%**作为工作窗口上限（避免推理/输出被挤压）

存储结构（公共 + 聊天独立，双模式）
真相源一律 append-only（只追加写），可审计、可回放、可重建索引。

global/（公共存储，可迁移第一性原理/长期原则）

principles/：原则（宪法层）与冲突裁决

stages/：按 scope 的阶段结论（可版本化）

tokenizer/：分词字典与自动词晋升事件

scopes/：固定字典映射（你要求“固定字典映射”，用 .taml）

index/：SQLite 倒排索引（派生物，可重建）

chats/<chat_folder>/（聊天独立存储，冻结聊天名）

memory/deltas.jsonl：每次压缩（delta）输出

memory/cold/*.jsonl：自动分类冷存（facts/decisions/open_threads/todo/conflicts/glossary）

memory/hot_context_versions.jsonl：热区上下文版本

分层记忆（强烈建议）
宪法层（Principles）：稳定原则、项目约束、不可违反项

阶段结论层（Stages）：最近一段时间的决策/结论（scope@vYYYYMMDD-NN，可版本化）

原始材料层（Raw/Evidence）：讨论过程、争论、草案、证据片段（仅必要时检索）

每次注入模型：优先 宪法 + 最近阶段结论 + 少量证据片段，其余通过多轮推理补齐。

上下文预算硬控（要求）
设定 context_budget_chars（默认 18000，可按你模型窗口调整）

分配固定比例：

宪法 10%

阶段结论 50%

热区 + 证据 40%

再配合触发规则（delta/merge/trim）避免无上限膨胀

分类与路由（自动推断）
free_tags：自由标签（可多）

route_tag：7 大顶层标签唯一命中（系统/战斗/关卡/数值/叙事/美术/运营），用固定优先级打破并列

scope：固定字典映射（.taml），scope 决定写入哪个 stage

记忆污染控制（你要求的晋升规则）
原则晋升：

用户显式指定加入（user_forced）→ 立即晋升

否则：同义归一化规则出现 ≥ 3 次才自动晋升

原则分级：

加入后每出现 10 次升一级（L1–L10）

冲突处理（强制打断）：

同级互斥命中 → 直接打断输出冲突簇

同级时让使用者裁决（keep #k），其余默认 suppressed

性能/效率提升但不牺牲准确度
真相源：append-only JSONL（正确性基准）

派生物：

增量快照（只处理新增行）

SQLite 倒排索引（快速检索）

严格 freshness check：索引不新鲜就回退扫快照/真相（准确度优先）
输入 / 输出契约
输入 Input

UserQuery：用户需求/问题

MemoryStore：本地库（分层存储 + 元数据）

Policy：宪法层原则/硬约束（最高优先级）

Budget：

context_token_budget：上下文预算

evidence_token_budget：证据注入预算（仅慢思考时扩大）

输出 Output

默认输出：FinalAnswer

可选输出（仅在必要时外显）：

OpenQuestions：仍需用户补充的最少必要信息

Assumptions：为了不给出无依据断言而做的条件化前提

Alternatives：冲突无法裁决时的分支方案

2) 数据结构
2.1 MemoryUnit（原子记忆单元）

建议字段（可按你的库简化）：

id

type：constitution | decision | semantic | episodic | snippet

content：原子陈述（尽量“一条规则/一个事实/一个结论”）

scope：适用范围（模块/系统/关卡/版本/对象）

version：版本号或生效区间（可空，但推荐）

priority：hard | soft | ref

confidence：0~1

provenance：来源（文档/会议/用户明确指令/日期）

tags：关键词/结构化标签

2.2 ContextPacket（上下文包）

固定结构（建议保持稳定）：

Task：任务目标（把 UserQuery 改写成可执行交付）

HardConstraints：宪法层 + 强约束决策

SoftConstraints：偏好/风格/口径

RelevantFacts：相关设定/事实（semantic）

RecentDecisions：近期决策（decision）

EvidenceSnippets（可选）：证据片段（snippet，慢思考时注入）

Risks：风险点/不确定点（由 S1 产出）

2.3 S1 输出：DraftPack

Draft：草稿正文

Claims[]：可核验主张列表（每条一句话）

DraftMeta：

confidence：0~1

conflict_count：0+

missing_critical_info：布尔 + 列表

risk_level：low | mid | high

complexity：simple | mid | complex

2.4 S2 输出：ReviewPack

Questions[]：质疑清单（先产出）

ResolutionNotes：每个问题的解决路径与结论（内部用）

RevisedAnswer：修正后的最终答案

OpenQuestions（可选）：仍需用户补充的信息

3) 流程
3.1 S1：快思考（FastDraft）

目标：在预算内生成可用草稿，同时产出“可被质疑”的结构化对象（Claims + Meta）。

步骤

意图解析：将 UserQuery 改写为 Task（交付物类型 + 范围 + 成功标准）

检索（混合）：

关键词召回（术语/ID/模块名）

语义召回（向量/embedding）

过滤（scope/version/priority）

压缩：生成 ContextPacket（硬约束优先，噪声剔除）

生成草稿：输出 Draft

抽取主张：把 Draft 拆为 Claims[]

快速自检打分：输出 DraftMeta 与 Risks

S1 质量底线

Draft 中任何关键断言必须能映射到：

HardConstraints/Decisions/Facts/Evidence 之一，或

明确标为 Assumption/Condition（不允许无依据断言）

3.2 Gate：是否进入慢思考（NeedSlow）

目标：用明确规则决定是否升级到“质疑式慢思考”。

Gate-0（微质疑，低成本，建议默认做）

对 Claims 中影响最大的 Top-3 做快速质疑（不额外检索，只生成 Questions 的雏形）

若无高风险信号，可直接输出 Draft（或轻微改写后输出）

Gate-1（完整慢思考）触发条件：满足任一条即进入

DraftMeta.confidence < 0.7

DraftMeta.conflict_count > 0

DraftMeta.risk_level == high

missing_critical_info == true 且 Draft 无法在不猜测下完成

微质疑产出的 Questions 中存在 severity == high

3.3 S2：慢思考（SlowChallenge）

核心要求：先提出疑问，再做修正（两阶段）。

Phase A：生成质疑清单 Questions（先不改稿）

对每条 claim 生成 0~N 个疑问条目：

QuestionItem 格式

target_claim_id

question

reason_type：

EvidenceGap | ConstraintRisk | VersionConflict | ScopeLeak | CausalLeap | Ambiguity | EdgeCase | Overcommit

severity：high | mid | low

needed_evidence

resolution_path：retrieve | adjudicate | soften | ask_user | delete

规则：优先输出 severity=high 的问题；数量上限建议为 Top-5（避免过度审计）。

Phase B：用 Questions 驱动行动（检索/裁决/改写）

按每个 Question 的 resolution_path 处理：

retrieve：补充检索证据 → 只注入与该问题相关的 snippet

adjudicate：冲突裁决（见下）

soften：把断言改成条件句/假设，降低承诺

ask_user：提“最少必要问题”（避免追问过多）

delete：删除无必要或高风险且不可证的 claim

完成后输出 RevisedAnswer，并仅在必要时外显 OpenQuestions/Assumptions/Alternatives。

4) 冲突裁决规则（Conflict Adjudication）

当检索到多条记忆冲突时，按以下优先级裁决：

宪法层 HardConstraints（constitution）

新版本决策（decision，version 更新者优先）

高置信证据（snippet/semantic with high confidence）

低置信陈述/过期 episodic

若仍无法裁决：

输出分支：Alternative A/B

明确每个分支的前提条件

如可行，向用户提出 1 个最关键澄清问题

5) 上下文预算与注入策略
注入优先级（从高到低）

HardConstraints

RecentDecisions

RelevantFacts

EvidenceSnippets（仅慢思考/有争议时）

其他背景

证据注入规则

S1：默认不注入大段 evidence，除非用户要求“严谨/依据”或检测到冲突

S2：只注入与 Questions 直接相关的证据片段（最小充分集）

6) 输出规范（对用户的呈现）

默认只输出 FinalAnswer（RevisedAnswer）。以下情况才外显额外结构：

需要用户补充：输出 OpenQuestions（<=3 条，最少必要）

存在不可裁决冲突：输出 Alternatives（分支 + 前提）

必须条件化：输出 Assumptions（把不可证部分降级为条件句）